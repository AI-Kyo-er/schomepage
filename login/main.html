<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schomepageä¸»é¡µç”Ÿæˆç³»ç»Ÿ - å·¥ä½œç«™</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f6fa;
            overflow: hidden;
        }
        
        /* é¡¶éƒ¨å·¥å…·æ  */
        .top-toolbar {
            background: #2c3e50;
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            position: relative;
        }
        
        .logo {
            font-size: 18px;
            font-weight: bold;
        }
        
        .user-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-info {
            font-size: 14px;
        }
        
        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background-color 0.3s;
        }
        
        .logout-btn:hover {
            background: #c0392b;
        }
        
        /* ä¸»å¸ƒå±€ */
        .main-layout {
            display: flex;
            height: calc(100vh - 60px);
        }
        
        /* å·¦ä¾§è¾¹æ  */
        .sidebar {
            width: 250px;
            background: white;
            border-right: 1px solid #e1e5e9;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #e1e5e9;
            background: #f8f9fa;
        }
        
        .sidebar-header h3 {
            color: #2c3e50;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .article-limit {
            font-size: 12px;
            color: #7f8c8d;
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
        }
        
        .sidebar-section {
            border-bottom: 1px solid #e1e5e9;
        }
        
        .section-header {
            padding: 15px 20px;
            background: #f8f9fa;
            font-weight: bold;
            font-size: 14px;
            color: #2c3e50;
            cursor: pointer;
            user-select: none;
        }
        
        .section-header:hover {
            background: #ecf0f1;
        }
        
        .section-content {
            padding: 10px;
        }
        
        /* æŒ‰é’®æ ·å¼ */
        .btn {
            display: block;
            width: 100%;
            padding: 10px 15px;
            margin-bottom: 8px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background: #2980b9;
        }
        
        .btn-success {
            background: #27ae60;
        }
        
        .btn-success:hover {
            background: #229954;
        }
        
        .btn-secondary {
            background: #7f8c8d;
        }
        
        .btn-secondary:hover {
            background: #6c7b7d;
        }
        
        /* æ–‡ç« åˆ—è¡¨ */
        .article-list {
            list-style: none;
        }
        
        .article-item {
            padding: 8px 15px;
            margin: 2px 0;
            background: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }
        
        .article-item:hover {
            background: #e9ecef;
        }
        
        .article-item.active {
            background: #3498db;
            color: white;
        }
        
        .article-name {
            flex: 1;
            margin-right: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .article-actions {
            display: flex;
            gap: 5px;
        }
        
        .icon-btn {
            width: 20px;
            height: 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 12px;
            border-radius: 2px;
        }
        
        .icon-btn:hover {
            background: rgba(0,0,0,0.1);
        }
        
        /* ä¸»ç¼–è¾‘åŒºåŸŸ */
        .editor-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }
        
        /* ç¼–è¾‘å™¨å·¥å…·æ  */
        .editor-toolbar {
            background: #f8f9fa;
            border-bottom: 1px solid #e1e5e9;
            padding: 10px 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .toolbar-group {
            display: flex;
            gap: 5px;
            padding-right: 15px;
            border-right: 1px solid #dee2e6;
        }
        
        .toolbar-group:last-child {
            border-right: none;
        }
        
        .toolbar-btn {
            padding: 6px 12px;
            border: 1px solid #dee2e6;
            background: white;
            cursor: pointer;
            border-radius: 3px;
            font-size: 13px;
            transition: all 0.2s;
        }
        
        .toolbar-btn:hover {
            background: #e9ecef;
        }
        
        .toolbar-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .toolbar-select {
            padding: 4px 8px;
            border: 1px solid #dee2e6;
            border-radius: 3px;
            background: white;
            font-size: 13px;
        }
        
        /* ç¼–è¾‘å™¨å†…å®¹åŒº */
        .editor-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        .canvas-container {
            flex: 1;
            background: #f8f9fa;
            padding: 20px;
            overflow: auto;
            position: relative;
        }
        
        .canvas {
            background: white;
            min-height: 800px;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            padding: 40px;
            position: relative;
            cursor: text;
        }
        
        /* å¯ç¼–è¾‘å…ƒç´  */
        .editable-element {
            position: relative;
            min-height: 20px;
            padding: 5px;
            margin: 5px 0;
            border: 1px dashed transparent;
            cursor: text;
        }
        
        .editable-element:hover {
            border-color: #3498db;
        }
        
        .editable-element.selected {
            border-color: #e74c3c;
            background: rgba(231, 76, 60, 0.05);
        }
        
        .element-controls {
            position: absolute;
            top: -25px;
            right: 0;
            display: none;
            gap: 2px;
        }
        
        .editable-element.selected .element-controls {
            display: flex;
        }
        
        .control-btn {
            width: 20px;
            height: 20px;
            background: #e74c3c;
            color: white;
            border: none;
            font-size: 11px;
            cursor: pointer;
            border-radius: 2px;
        }
        
        /* å›¾ç‰‡å…ƒç´  */
        .image-element {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 10px 0;
        }
        
        /* å³ä¾§å±æ€§é¢æ¿ */
        .properties-panel {
            width: 280px;
            background: white;
            border-left: 1px solid #e1e5e9;
            display: flex;
            flex-direction: column;
        }
        
        .panel-header {
            padding: 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #e1e5e9;
            font-weight: bold;
            font-size: 14px;
            color: #2c3e50;
        }
        
        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        
        .property-group {
            margin-bottom: 20px;
        }
        
        .property-label {
            display: block;
            margin-bottom: 5px;
            font-size: 13px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .property-input {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid #dee2e6;
            border-radius: 3px;
            font-size: 13px;
        }
        
        .color-picker {
            width: 100%;
            height: 30px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        
        /* ç´ æåº“ */
        .assets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }
        
        .asset-item {
            width: 60px;
            height: 60px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .asset-item:hover {
            background: #e9ecef;
            border-color: #3498db;
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .asset-item img {
            max-width: 50px;
            max-height: 50px;
            object-fit: contain;
        }
        
        /* æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-shrink: 0;
        }
        
        .modal-body {
            flex: 1;
            overflow-y: auto;
            max-height: 60vh;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #7f8c8d;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .properties-panel {
                width: 220px;
            }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 200px;
            }
            .properties-panel {
                display: none;
            }
        }
        
        /* åŠ è½½çŠ¶æ€ */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: #7f8c8d;
        }
        
        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            color: #7f8c8d;
            padding: 40px 20px;
        }
        
        .empty-state h3 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        /* è®¿å®¢ç»Ÿè®¡æ ·å¼ */
        .visitor-stats-list {
            list-style: none;
        }
        
        .visitor-stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin: 4px 0;
            background: #f8f9fa;
            border-radius: 4px;
            border-left: 4px solid #3498db;
            font-size: 13px;
        }
        
        .visitor-stat-item:hover {
            background: #e9ecef;
        }
        
        .visitor-identity {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .visitor-count {
            background: #3498db;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            min-width: 24px;
            text-align: center;
        }
        
        .no-visitors {
            text-align: center;
            color: #7f8c8d;
            font-style: italic;
            padding: 20px 10px;
            background: #f8f9fa;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        /* éªŒè¯ç è¾“å…¥ç»„æ ·å¼ */
        .verification-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .verification-input-group input {
            flex: 1;
        }
        .verification-input-group button {
            flex: 0 0 auto;
            width: 100px;
        }
        
        /* äººæœºéªŒè¯æ ·å¼ */
        .captcha-container {
            text-align: center;
            padding: 30px 20px;
        }
        .captcha-container h3 {
            font-size: 24px;
            color: #333;
            margin-bottom: 30px;
            font-weight: bold;
        }
        .captcha-checkbox {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 40px 0;
            font-size: 16px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 10px;
            border: 2px dashed #dee2e6;
        }
        .captcha-checkbox input {
            width: auto;
            margin-right: 15px;
            transform: scale(1.2);
        }
        .captcha-checkbox label {
            color: #495057;
            font-weight: 500;
        }
        
        /* å¯†ç å¼ºåº¦æ ·å¼ */
        .password-strength {
            margin-top: 5px;
            font-size: 14px;
        }
        .strength-weak { color: #e74c3c; }
        .strength-medium { color: #f39c12; }
        .strength-strong { color: #27ae60; }
        .strength-very-strong { color: #2ecc71; }
        
        /* é”™è¯¯å’ŒæˆåŠŸæ¶ˆæ¯æ ·å¼ */
        .error-message {
            color: #e74c3c;
            margin-top: 15px;
            display: none;
        }
        .success-message {
            color: #27ae60;
            margin-top: 15px;
            display: none;
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å·¥å…·æ  -->
    <div class="top-toolbar">
        <div class="logo">Schomepageä¸»é¡µç”Ÿæˆç³»ç»Ÿ</div>
        <div class="user-controls">
            <div class="user-info">
                <span>æ¬¢è¿ï¼Œ<span id="currentUser">ç”¨æˆ·</span></span>
                <span class="article-limit" id="articleLimit"></span>
            </div>
            <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
        </div>
    </div>

    <!-- ä¸»å¸ƒå±€ -->
    <div class="main-layout">
        <!-- å·¦ä¾§è¾¹æ  -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h3>æˆ‘çš„æ–‡ç« </h3>
                <div class="article-limit" id="sidebarArticleLimit">åŠ è½½ä¸­...</div>
            </div>
            
            <div class="sidebar-content">
                <!-- æ–‡ç« ç®¡ç† -->
                <div class="sidebar-section">
                    <div class="section-header" onclick="toggleSection('articles')">ğŸ“„ æ–‡ç« ç®¡ç†</div>
                    <div class="section-content" id="articles">
                        <button class="btn btn-success" onclick="createNewArticle()">â• æ–°å»ºæ–‡ç« </button>
                        <ul class="article-list" id="articleList">
                            <li class="loading">åŠ è½½æ–‡ç« åˆ—è¡¨...</li>
                        </ul>
                    </div>
                </div>
                
                <!-- ç´ æåº“ -->
                <div class="sidebar-section">
                    <div class="section-header" onclick="toggleSection('assets')">ğŸ¨ ç´ æåº“</div>
                    <div class="section-content" id="assets" style="display: none;">
                        <button class="btn btn-secondary" onclick="showAssetLibrary('backgrounds')">èƒŒæ™¯å›¾ç‰‡</button>
                        <button class="btn btn-secondary" onclick="showAssetLibrary('icons')">å›¾æ ‡åº“</button>
                        <button class="btn btn-secondary" onclick="showMyPictures()">æˆ‘çš„å›¾ç‰‡</button>
                    </div>
                </div>
                
                <!-- æ¨¡æ¿åº“ -->
                <div class="sidebar-section">
                    <div class="section-header" onclick="toggleSection('templates')">ğŸ“‹ æ¨¡æ¿åº“</div>
                    <div class="section-content" id="templates" style="display: none;">
                        <button class="btn btn-secondary" onclick="applyTemplate('article')">æ–‡ç« æ¨¡æ¿</button>
                        <button class="btn btn-secondary" onclick="applyTemplate('blog')">åšå®¢æ¨¡æ¿</button>
                        <button class="btn btn-secondary" onclick="applyTemplate('news')">æ–°é—»æ¨¡æ¿</button>
                    </div>
                </div>

                <!-- è®¿å®¢ç»Ÿè®¡ -->
                <div class="sidebar-section">
                    <div class="section-header" onclick="toggleSection('visitor-stats')">ğŸ“Š è®¿å®¢ç»Ÿè®¡</div>
                    <div class="section-content" id="visitor-stats" style="display: none;">
                        <div id="visitorStatsContent">
                            <div class="loading">åŠ è½½è®¿å®¢ç»Ÿè®¡...</div>
                        </div>
                        <button class="btn btn-secondary" onclick="refreshVisitorStats()">ğŸ”„ åˆ·æ–°ç»Ÿè®¡</button>
                    </div>
                </div>

                <!-- ä¿®æ”¹å¯†ç  -->
                <div class="sidebar-section">
                    <div class="section-header" onclick="toggleSection('change-password')">ğŸ”‘ ä¿®æ”¹å¯†ç </div>
                    <div class="section-content" id="change-password" style="display: none;">
                        <button class="btn btn-secondary" onclick="showChangePasswordModal()">ğŸ”‘ ä¿®æ”¹å¯†ç </button>
                    </div>
                </div>

                <!-- è®¿å®¢é€šé“ -->
                <div class="sidebar-section">
                    <div class="section-header" onclick="toggleSection('visitor-access')">ğŸŒ è®¿å®¢é€šé“</div>
                    <div class="section-content" id="visitor-access" style="display: none;">
                        <button class="btn btn-secondary" onclick="showVisitorAccessModal()">ğŸŒ ç®¡ç†è®¿å®¢é“¾æ¥</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¸»ç¼–è¾‘åŒºåŸŸ -->
        <div class="editor-area">
            <!-- ç¼–è¾‘å™¨å·¥å…·æ  -->
            <div class="editor-toolbar">
                <div class="toolbar-group">
                    <button class="toolbar-btn" onclick="saveArticle()" title="ä¿å­˜">ğŸ’¾</button>
                    <button class="toolbar-btn" onclick="previewArticle()" title="é¢„è§ˆ">ğŸ‘ï¸</button>
                    <button class="toolbar-btn" onclick="exportArticle()" title="å¯¼å‡º">ğŸ“¤</button>
                </div>
                
                <div class="toolbar-group">
                    <button class="toolbar-btn" onclick="undo()" title="æ’¤é”€">â†¶</button>
                    <button class="toolbar-btn" onclick="redo()" title="é‡åš">â†·</button>
                </div>
                
                <div class="toolbar-group">
                    <select class="toolbar-select" id="fontFamily" onchange="changeFontFamily()">
                        <option value="Arial, sans-serif">Arial</option>
                        <option value="Georgia, serif">Georgia</option>
                        <option value="Times New Roman, serif">Times New Roman</option>
                        <option value="Verdana, sans-serif">Verdana</option>
                        <option value="Microsoft YaHei, sans-serif">å¾®è½¯é›…é»‘</option>
                        <option value="SimSun, serif">å®‹ä½“</option>
                    </select>
                    
                    <select class="toolbar-select" id="fontSize" onchange="changeFontSize()">
                        <option value="12px">12px</option>
                        <option value="14px">14px</option>
                        <option value="16px" selected>16px</option>
                        <option value="18px">18px</option>
                        <option value="20px">20px</option>
                        <option value="24px">24px</option>
                        <option value="32px">32px</option>
                    </select>
                </div>
                
                <div class="toolbar-group">
                    <button class="toolbar-btn" onclick="toggleBold()" id="boldBtn" title="ç²—ä½“">B</button>
                    <button class="toolbar-btn" onclick="toggleItalic()" id="italicBtn" title="æ–œä½“">I</button>
                    <button class="toolbar-btn" onclick="toggleUnderline()" id="underlineBtn" title="ä¸‹åˆ’çº¿">U</button>
                </div>
                
                <div class="toolbar-group">
                    <button class="toolbar-btn" onclick="setAlignment('left')" title="å·¦å¯¹é½">â¬…</button>
                    <button class="toolbar-btn" onclick="setAlignment('center')" title="å±…ä¸­">â¬Œ</button>
                    <button class="toolbar-btn" onclick="setAlignment('right')" title="å³å¯¹é½">â¡</button>
                </div>
                
                <div class="toolbar-group">
                    <button class="toolbar-btn" onclick="insertTextBox()" title="æ’å…¥æ–‡æœ¬æ¡†">ğŸ“</button>
                    <button class="toolbar-btn" onclick="insertImage()" title="æ’å…¥å›¾ç‰‡">ğŸ–¼ï¸</button>
                    <button class="toolbar-btn" onclick="insertLink()" title="æ’å…¥é“¾æ¥">ğŸ”—</button>
                    <button class="toolbar-btn" onclick="toggleDynamicHide()" title="åŠ¨æ€éšè—æ¨¡å—">ğŸ­</button>
                </div>
            </div>
            
            <!-- ç¼–è¾‘å™¨å†…å®¹åŒº -->
            <div class="editor-content">
                <div class="canvas-container">
                    <div class="canvas" id="canvas">
                        <div class="empty-state" id="emptyState">
                            <h3>å¼€å§‹åˆ›ä½œæ‚¨çš„æ–‡ç« </h3>
                            <p>ç‚¹å‡»å·¥å…·æ æŒ‰é’®æ·»åŠ æ–‡æœ¬ã€å›¾ç‰‡æˆ–å…¶ä»–å…ƒç´ </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§å±æ€§é¢æ¿ -->
        <div class="properties-panel">
            <div class="panel-header">å±æ€§é¢æ¿</div>
            <div class="panel-content" id="propertiesContent">
                <div class="empty-state">
                    <p>é€‰æ‹©å…ƒç´ ä»¥ç¼–è¾‘å±æ€§</p>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ€æ¡† -->
    <div class="modal" id="assetModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">ç´ æåº“</h3>
                <button class="close-btn" onclick="closeModal('assetModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="modalContent">
                    <div class="loading">åŠ è½½ç´ æ...</div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="imageModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ’å…¥å›¾ç‰‡</h3>
                <button class="close-btn" onclick="closeModal('imageModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div>
                    <input type="file" id="imageFile" accept="image/*" onchange="handleImageUpload()">
                    <p style="margin-top: 10px; font-size: 13px; color: #7f8c8d;">
                        æˆ–è€…ä»ç´ æåº“é€‰æ‹©èƒŒæ™¯å›¾ç‰‡
                    </p>
                    <div class="assets-grid" id="backgroundAssets">
                        <!-- èƒŒæ™¯å›¾ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="myPicturesModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æˆ‘çš„å›¾ç‰‡</h3>
                <button class="close-btn" onclick="closeModal('myPicturesModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 15px; text-align: center;">
                    <input type="file" id="uploadImageFile" accept=".png,.jpg,.jpeg" multiple style="display: none;" onchange="handleMyImageUpload()">
                    <button class="btn btn-success" onclick="document.getElementById('uploadImageFile').click()">ğŸ“¤ å¯¼å…¥å›¾ç‰‡</button>
                    <p style="margin-top: 8px; font-size: 12px; color: #7f8c8d;">æ”¯æŒ PNGã€JPG æ ¼å¼</p>
                </div>
                <div id="myPicturesContent">
                    <div class="loading">åŠ è½½æˆ‘çš„å›¾ç‰‡...</div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="linkModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ’å…¥æ–‡ç« é“¾æ¥</h3>
                <button class="close-btn" onclick="closeModal('linkModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="property-group">
                    <label class="property-label">é“¾æ¥æ–‡æœ¬</label>
                    <input type="text" id="linkText" class="property-input" placeholder="è¯·è¾“å…¥é“¾æ¥æ˜¾ç¤ºçš„æ–‡æœ¬" value="ç‚¹å‡»è¿™é‡Œ">
                </div>
                
                <div class="property-group">
                    <label class="property-label">é€‰æ‹©ç›®æ ‡æ–‡ç« </label>
                    <div id="linkTargetList">
                        <div class="loading">åŠ è½½æ–‡ç« åˆ—è¡¨...</div>
                    </div>
                </div>
                
                <div class="property-group">
                    <label class="property-label">é“¾æ¥ç±»å‹</label>
                    <select id="linkType" class="property-input">
                        <option value="text">æ–‡æœ¬é“¾æ¥</option>
                        <option value="image">å›¾ç‰‡é“¾æ¥ï¼ˆå°†é€‰ä¸­çš„å›¾ç‰‡è®¾ä¸ºé“¾æ¥ï¼‰</option>
                    </select>
                </div>
                
                <div style="text-align: right; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="closeModal('linkModal')" style="margin-right: 10px;">å–æ¶ˆ</button>
                    <button class="btn btn-success" onclick="insertLinkElement()">æ’å…¥é“¾æ¥</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¿®æ”¹å¯†ç æ¨¡æ€æ¡† -->
    <div class="modal" id="changePasswordModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ä¿®æ”¹å¯†ç </h3>
                <button class="close-btn" onclick="closeModal('changePasswordModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="property-group">
                    <label class="property-label">å½“å‰å¯†ç </label>
                    <input type="password" id="currentPassword" class="property-input" placeholder="è¯·è¾“å…¥å½“å‰å¯†ç ">
                </div>
                
                <div class="property-group">
                    <label class="property-label">éªŒè¯ç </label>
                    <div class="verification-input-group">
                        <input type="text" id="changePasswordVerificationCode" class="property-input" placeholder="è¯·è¾“å…¥éªŒè¯ç ">
                        <button class="btn btn-secondary" onclick="sendChangePasswordCode()" id="sendChangePasswordCodeBtn">å‘é€éªŒè¯ç </button>
                    </div>
                    <div id="changePasswordCountdown" style="font-size: 12px; color: #666; margin-top: 5px;"></div>
                </div>
                
                <div id="changePasswordErrorMessage" class="error-message" style="display: none;"></div>
                <div id="changePasswordSuccessMessage" class="success-message" style="display: none;"></div>
                
                <div style="text-align: right; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="closeModal('changePasswordModal')" style="margin-right: 10px;">å–æ¶ˆ</button>
                    <button class="btn btn-success" onclick="proceedToNewPassword()">ä¸‹ä¸€æ­¥</button>
                </div>
            </div>
        </div>
    </div>

    <!-- è®¾ç½®æ–°å¯†ç æ¨¡æ€æ¡† -->
    <div class="modal" id="newPasswordModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>è®¾ç½®æ–°å¯†ç </h3>
                <button class="close-btn" onclick="closeModal('newPasswordModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="property-group">
                    <label class="property-label">æ–°å¯†ç </label>
                    <input type="password" id="newPassword" class="property-input" placeholder="è¯·è¾“å…¥æ–°å¯†ç  (6-16ä½)" oninput="checkNewPasswordStrength()">
                </div>
                
                <div class="property-group">
                    <label class="property-label">ç¡®è®¤æ–°å¯†ç </label>
                    <input type="password" id="confirmNewPassword" class="property-input" placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç ">
                </div>
                
                <div id="newPasswordStrength" class="password-strength"></div>
                <div id="newPasswordErrorMessage" class="error-message" style="display: none;"></div>
                <div id="newPasswordSuccessMessage" class="success-message" style="display: none;"></div>
                
                <div style="text-align: right; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="closeModal('newPasswordModal')" style="margin-right: 10px;">å–æ¶ˆ</button>
                    <button class="btn btn-success" onclick="updateUserPassword()">ç¡®è®¤ä¿®æ”¹</button>
                </div>
            </div>
        </div>
    </div>

    <!-- äººæœºéªŒè¯æ¨¡æ€æ¡†ï¼ˆä¿®æ”¹å¯†ç ç”¨ï¼‰ -->
    <div class="modal" id="changePasswordCaptchaModal">
        <div class="modal-content">
            <div class="modal-header">
                <button class="close-btn" onclick="closeModal('changePasswordCaptchaModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="captcha-container">
                    <h3>å®‰å…¨éªŒè¯</h3>
                    <div class="captcha-checkbox">
                        <input type="checkbox" id="changePasswordRobotCheck" onchange="handleChangePasswordCaptcha()">
                        <label for="changePasswordRobotCheck">ç‚¹å‡»è¿™é‡Œï¼Œç¡®ä¿æ‚¨ä¸æ˜¯æœºå™¨äºº</label>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-success" onclick="confirmChangePasswordCaptcha()" id="changePasswordCaptchaConfirm" disabled>ç¡®è®¤</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è®¿å®¢é€šé“æ¨¡æ€æ¡† -->
    <div class="modal" id="visitorAccessModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>è®¿å®¢é€šé“ç®¡ç†</h3>
                <button class="close-btn" onclick="closeModal('visitorAccessModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <h4>æˆ‘çš„è®¿å®¢é“¾æ¥</h4>
                    <div id="visitorLinksList">
                        <div class="loading">åŠ è½½è®¿å®¢é“¾æ¥...</div>
                    </div>
                </div>
                
                <div style="border-top: 1px solid #eee; padding-top: 20px;">
                    <h4>æ·»åŠ æ–°çš„è®¿å®¢é“¾æ¥</h4>
                    <div class="property-group">
                        <label class="property-label">é€‰æ‹©æ–‡ç« </label>
                        <select id="visitorArticleSelect" class="property-input">
                            <option value="">è¯·é€‰æ‹©æ–‡ç« </option>
                        </select>
                    </div>
                    
                    <div class="property-group">
                        <label class="property-label">åˆ«å</label>
                        <input type="text" id="visitorAlias" class="property-input" placeholder="è¾“å…¥è®¿å®¢è®¿é—®çš„åˆ«å">
                    </div>
                    
                    <div style="text-align: right; margin-top: 15px;">
                        <button class="btn btn-success" onclick="addVisitorLink()">æ·»åŠ é“¾æ¥</button>
                    </div>
                </div>
                
                <div id="visitorAccessErrorMessage" class="error-message" style="display: none;"></div>
                <div id="visitorAccessSuccessMessage" class="success-message" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script src="auth.js"></script>
    <script src="editor.js"></script>
    <script src="crypto.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let currentUser = '';
        let currentArticle = null;
        let selectedElement = null;
        let undoStack = [];
        let redoStack = [];
        let maxArticles = 0;
        let articleCount = 0;

        // é¡µé¢åˆå§‹åŒ–
        window.onload = function() {
            debugLog('ç¼–è¾‘å™¨é¡µé¢åŠ è½½å®Œæˆ');
            checkAuth();
            initializeEditor();
            setupUndoRedoListeners(); // è®¾ç½®æ’¤é”€é‡åšç›‘å¬å™¨
        };

        function initializeEditor() {
            currentUser = sessionStorage.getItem('currentUser');
            if (currentUser) {
                document.getElementById('currentUser').textContent = currentUser;
                loadUserArticles();
                loadUserLimits();
                loadBackgroundAssets();
                loadVisitorStats(); // åŠ è½½è®¿å®¢ç»Ÿè®¡
                
                // åˆå§‹åŒ–æ’¤é”€æ ˆ
                setTimeout(() => {
                    saveInitialStateToUndoStack();
                }, 500); // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½
            }
        }

        // ğŸ”§ ä¿®å¤1: åˆå§‹åŒ–æ’¤é”€æ ˆ
        function saveInitialStateToUndoStack() {
            const initialState = getCanvasContent();
            undoStack.push(initialState);
            console.log('åˆå§‹çŠ¶æ€å·²ä¿å­˜åˆ°æ’¤é”€æ ˆ');
        }

        // ğŸ”§ ä¿®å¤2: è‡ªå®šä¹‰å¯¹è¯æ¡†æ›¿æ¢prompt
        function showCustomPrompt(message, defaultValue = '') {
            return new Promise((resolve) => {
                // åˆ›å»ºè‡ªå®šä¹‰å¯¹è¯æ¡†
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>è¾“å…¥ä¿¡æ¯</h3>
                        </div>
                        <p>${message}</p>
                        <input type="text" id="promptInput" value="${defaultValue}" style="width: 100%; padding: 8px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px;">
                        <div style="text-align: right; margin-top: 15px;">
                            <button onclick="closeCustomPrompt(false)" style="margin-right: 10px; padding: 8px 15px; background: #ccc; border: none; border-radius: 4px; cursor: pointer;">å–æ¶ˆ</button>
                            <button onclick="closeCustomPrompt(true)" style="padding: 8px 15px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">ç¡®å®š</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                document.getElementById('promptInput').focus();
                
                // å¤„ç†å›è½¦é”®
                document.getElementById('promptInput').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        closeCustomPrompt(true);
                    }
                });
                
                window.closeCustomPrompt = function(confirmed) {
                    const value = confirmed ? document.getElementById('promptInput').value : null;
                    document.body.removeChild(modal);
                    delete window.closeCustomPrompt;
                    resolve(value);
                };
            });
        }

        // åŠ è½½ç”¨æˆ·æ–‡ç« é™åˆ¶
        async function loadUserLimits() {
            try {
                const response = await fetch('/api/user_limits', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username: currentUser })
                });
                
                const data = await response.json();
                if (data.success) {
                    maxArticles = data.maxarticle;
                    updateArticleLimitDisplay();
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·é™åˆ¶å¤±è´¥:', error);
            }
        }

        // æ›´æ–°æ–‡ç« é™åˆ¶æ˜¾ç¤º
        function updateArticleLimitDisplay() {
            const limitText = `(${articleCount}/${maxArticles})`;
            document.getElementById('articleLimit').textContent = limitText;
            document.getElementById('sidebarArticleLimit').textContent = limitText;
        }

        // åŠ è½½ç”¨æˆ·æ–‡ç« åˆ—è¡¨
        async function loadUserArticles() {
            try {
                const response = await fetch('/api/user_articles', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username: currentUser })
                });
                
                const data = await response.json();
                if (data.success) {
                    articleCount = data.articles.length;
                    updateArticleLimitDisplay();
                    displayArticleList(data.articles);
                } else {
                    showError('åŠ è½½æ–‡ç« åˆ—è¡¨å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                console.error('åŠ è½½æ–‡ç« åˆ—è¡¨å¤±è´¥:', error);
                showError('ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•åŠ è½½æ–‡ç« åˆ—è¡¨');
            }
        }

        // æ˜¾ç¤ºæ–‡ç« åˆ—è¡¨
        function displayArticleList(articles) {
            const articleList = document.getElementById('articleList');
            if (articles.length === 0) {
                articleList.innerHTML = '<li class="empty-state"><p>è¿˜æ²¡æœ‰æ–‡ç« </p></li>';
                return;
            }

            articleList.innerHTML = articles.map(article => `
                <li class="article-item" onclick="loadArticle('${article.filename}')">
                    <span class="article-name" title="${article.name}">${article.name}</span>
                    <div class="article-actions">
                        <button class="icon-btn" onclick="event.stopPropagation(); renameArticle('${article.filename}')" title="é‡å‘½å">âœï¸</button>
                        <button class="icon-btn" onclick="event.stopPropagation(); deleteArticle('${article.filename}')" title="åˆ é™¤">ğŸ—‘ï¸</button>
                    </div>
                </li>
            `).join('');
        }

        // åˆ‡æ¢ä¾§è¾¹æ éƒ¨åˆ†
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            section.style.display = section.style.display === 'none' ? 'block' : 'none';
        }

        // æ–°å»ºæ–‡ç« 
        async function createNewArticle() {
            if (articleCount >= maxArticles) {
                alert(`æ‚¨å·²è¾¾åˆ°æ–‡ç« æ•°é‡é™åˆ¶ (${maxArticles}ç¯‡)ï¼Œè¯·åˆ é™¤ä¸€äº›æ–‡ç« åå†åˆ›å»ºæ–°æ–‡ç« ã€‚`);
                return;
            }

            // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨è‡ªå®šä¹‰å¯¹è¯æ¡†
            const name = await showCustomPrompt('è¯·è¾“å…¥æ–‡ç« åç§°:', 'article');
            if (!name) return;

            try {
                const response = await fetch('/api/create_article', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        username: currentUser,
                        name: name
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    // æ›´æ–°æ–‡ç« åˆ—è¡¨
                    await loadUserArticles();
                    // åŠ è½½æ–°åˆ›å»ºçš„æ–‡ç«  - ä¿®å¤åŠ è½½é—®é¢˜
                    currentArticle = data.filename;
                    await loadArticleContent(data.filename);
                } else {
                    showError('åˆ›å»ºæ–‡ç« å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                console.error('åˆ›å»ºæ–‡ç« å¤±è´¥:', error);
                showError('ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•åˆ›å»ºæ–‡ç« ');
            }
        }

        // åŠ è½½æ–‡ç« å†…å®¹çš„è¾…åŠ©å‡½æ•°
        async function loadArticleContent(filename) {
            try {
                const response = await fetch('/api/load_article', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        username: currentUser,
                        filename: filename
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    loadContentToCanvas(data.content);
                    
                    // æ›´æ–°æ´»åŠ¨æ–‡ç« æ˜¾ç¤º
                    document.querySelectorAll('.article-item').forEach(item => {
                        item.classList.remove('active');
                        if (item.onclick.toString().includes(filename)) {
                            item.classList.add('active');
                        }
                    });
                } else {
                    showError('åŠ è½½æ–‡ç« å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                console.error('åŠ è½½æ–‡ç« å¤±è´¥:', error);
                showError('ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•åŠ è½½æ–‡ç« ');
            }
        }

        // åŠ è½½æ–‡ç« 
        async function loadArticle(filename) {
            currentArticle = filename;
            await loadArticleContent(filename);
        }

        // ä¿å­˜æ–‡ç« 
        async function saveArticle() {
            if (!currentArticle) {
                alert('è¯·å…ˆé€‰æ‹©æˆ–åˆ›å»ºä¸€ç¯‡æ–‡ç« ');
                return;
            }

            const content = getCanvasContent();
            
            try {
                const response = await fetch('/api/save_article', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        username: currentUser,
                        filename: currentArticle,
                        content: content
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    showSuccess('æ–‡ç« ä¿å­˜æˆåŠŸ');
                } else {
                    showError('ä¿å­˜æ–‡ç« å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                console.error('ä¿å­˜æ–‡ç« å¤±è´¥:', error);
                showError('ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•ä¿å­˜æ–‡ç« ');
            }
        }

        // è·å–ç”»å¸ƒå†…å®¹ - ä¿®æ”¹ä¸ºç§»é™¤æ‰€æœ‰æ§åˆ¶å…ƒç´ 
        function getCanvasContent() {
            const canvas = document.getElementById('canvas');
            const emptyState = document.getElementById('emptyState');
            
            // åˆ›å»ºç”»å¸ƒçš„å‰¯æœ¬æ¥å¤„ç†ï¼Œé¿å…å½±å“åŸå§‹å†…å®¹
            const canvasCopy = canvas.cloneNode(true);
            
            // ç§»é™¤ç©ºçŠ¶æ€
            const emptyStateInCopy = canvasCopy.querySelector('#emptyState');
            if (emptyStateInCopy) {
                emptyStateInCopy.remove();
            }
            
            // ç§»é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
            canvasCopy.querySelectorAll('.editable-element').forEach(el => {
                el.classList.remove('selected');
            });
            
            // ç§»é™¤æ‰€æœ‰æ§åˆ¶æŒ‰é’®
            canvasCopy.querySelectorAll('.element-controls').forEach(controls => {
                controls.remove();
            });
            
            // ğŸ”§ ä¿®å¤1: ç§»é™¤æ‰€æœ‰éšè—æŒ‡ç¤ºå™¨ï¼ˆä»…åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹æ˜¾ç¤ºï¼‰
            canvasCopy.querySelectorAll('.hide-indicator').forEach(indicator => {
                indicator.remove();
            });
            
            return canvasCopy.innerHTML;
        }

        // åŠ è½½å†…å®¹åˆ°ç”»å¸ƒ
        function loadContentToCanvas(content) {
            const canvas = document.getElementById('canvas');
            const emptyState = document.getElementById('emptyState');
            
            if (content && content.trim() !== '') {
                canvas.innerHTML = content;
                if (emptyState) emptyState.style.display = 'none';
                
                // é‡æ–°ç»‘å®šäº‹ä»¶
                bindElementEvents();
            } else {
                canvas.innerHTML = '<div class="empty-state" id="emptyState"><h3>å¼€å§‹åˆ›ä½œæ‚¨çš„æ–‡ç« </h3><p>ç‚¹å‡»å·¥å…·æ æŒ‰é’®æ·»åŠ æ–‡æœ¬ã€å›¾ç‰‡æˆ–å…¶ä»–å…ƒç´ </p></div>';
            }
        }

        // ç»‘å®šå…ƒç´ äº‹ä»¶
        function bindElementEvents() {
            document.querySelectorAll('.editable-element').forEach(element => {
                element.addEventListener('click', selectElement);
                // æ›´æ–°åŠ¨æ€éšè—æŒ‡ç¤ºå™¨
                updateElementHideIndicator(element);
            });
        }

        // æ’å…¥æ–‡æœ¬æ¡†
        function insertTextBox() {
            // å…ˆä¿å­˜å½“å‰çŠ¶æ€åˆ°æ’¤é”€æ ˆ
            saveStateToUndoStack();
            
            const canvas = document.getElementById('canvas');
            const emptyState = document.getElementById('emptyState');
            
            if (emptyState) emptyState.style.display = 'none';
            
            const textBox = document.createElement('div');
            textBox.className = 'editable-element';
            textBox.contentEditable = true;
            textBox.innerHTML = `
                ç‚¹å‡»è¿™é‡Œè¾“å…¥æ–‡æœ¬...
                <div class="element-controls">
                    <button class="control-btn" onclick="deleteElement(this)" title="åˆ é™¤">Ã—</button>
                    <button class="control-btn" onclick="moveUp(this)" title="ä¸Šç§»">â†‘</button>
                    <button class="control-btn" onclick="moveDown(this)" title="ä¸‹ç§»">â†“</button>
                </div>
            `;
            
            canvas.appendChild(textBox);
            textBox.addEventListener('click', selectElement);
            
            selectElement({ target: textBox });
            
            // é€‰ä¸­æ–‡æœ¬ä»¥ä¾¿ç¼–è¾‘
            textBox.focus();
            const range = document.createRange();
            range.selectNodeContents(textBox);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            
            console.log('æ–‡æœ¬æ¡†å·²æ’å…¥');
        }

        // æ’å…¥å›¾ç‰‡
        function insertImage() {
            document.getElementById('imageModal').style.display = 'block';
        }

        // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
        function handleImageUpload() {
            const file = document.getElementById('imageFile').files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                insertImageElement(e.target.result);
                closeModal('imageModal');
            };
            reader.readAsDataURL(file);
        }

        // æ’å…¥å›¾ç‰‡å…ƒç´  - ä¿®å¤å›¾ç‰‡æ˜¾ç¤ºé—®é¢˜
        function insertImageElement(src) {
            console.log('æ’å…¥å›¾ç‰‡:', src);
            
            // å…ˆä¿å­˜å½“å‰çŠ¶æ€åˆ°æ’¤é”€æ ˆ
            saveStateToUndoStack();
            
            const canvas = document.getElementById('canvas');
            const emptyState = document.getElementById('emptyState');
            
            if (emptyState) emptyState.style.display = 'none';
            
            const imageContainer = document.createElement('div');
            imageContainer.className = 'editable-element';
            
            // ğŸ”§ ä¿®å¤å›¾ç‰‡è·¯å¾„å¤„ç†é€»è¾‘
            let imageSrc = src;
            
            // å¯¹äº"æˆ‘çš„å›¾ç‰‡"ï¼ˆç”¨æˆ·å›¾ç‰‡APIï¼‰ï¼Œä¿æŒåŸè·¯å¾„
            if (src.startsWith('/api/get_user_picture/')) {
                imageSrc = src;
                console.log('âœ… ç”¨æˆ·å›¾ç‰‡è·¯å¾„:', imageSrc);
            }
            // å¯¹äºèƒŒæ™¯å›¾ç‰‡ï¼Œä½¿ç”¨å®Œæ•´è·¯å¾„
            else if (!src.startsWith('http') && !src.startsWith('/workplace/share/') && !src.startsWith('/api/')) {
                imageSrc = '/workplace/share/backgrounds/' + src;
                console.log('âœ… èƒŒæ™¯å›¾ç‰‡è·¯å¾„:', imageSrc);
            }
            // å…¶ä»–æƒ…å†µä¿æŒåŸè·¯å¾„
            else {
                imageSrc = src;
                console.log('âœ… å…¶ä»–å›¾ç‰‡è·¯å¾„:', imageSrc);
            }
            
            imageContainer.innerHTML = `
                <img src="${imageSrc}" class="image-element" style="max-width: 100%; height: auto; display: block; margin: 0 auto 0 0;" onload="console.log('å›¾ç‰‡åŠ è½½æˆåŠŸ:', this.src)" onerror="console.error('å›¾ç‰‡åŠ è½½å¤±è´¥:', this.src); this.style.border='2px solid red'; this.alt='å›¾ç‰‡åŠ è½½å¤±è´¥: ' + this.src;">
                <div class="element-controls">
                    <button class="control-btn" onclick="deleteElement(this)" title="åˆ é™¤">Ã—</button>
                    <button class="control-btn" onclick="moveUp(this)" title="ä¸Šç§»">â†‘</button>
                    <button class="control-btn" onclick="moveDown(this)" title="ä¸‹ç§»">â†“</button>
                </div>
            `;
            
            canvas.appendChild(imageContainer);
            imageContainer.addEventListener('click', selectElement);
            selectElement({ target: imageContainer });
            
            console.log('âœ… å›¾ç‰‡å…ƒç´ å·²æ’å…¥ï¼Œæœ€ç»ˆè·¯å¾„:', imageSrc);
        }

        // é€‰æ‹©å…ƒç´ 
        function selectElement(event) {
            // æ¸…é™¤ä¹‹å‰çš„é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.editable-element').forEach(el => {
                el.classList.remove('selected');
            });
            
            const element = event.target.closest('.editable-element');
            if (element) {
                element.classList.add('selected');
                selectedElement = element;
                showElementProperties(element);
            }
        }

        // æ˜¾ç¤ºå…ƒç´ å±æ€§
        function showElementProperties(element) {
            const propertiesContent = document.getElementById('propertiesContent');
            const isTextElement = element.contentEditable === 'true';
            const isImageElement = element.querySelector('.image-element');
            
            let propertiesHTML = '<div class="property-group">';
            
            if (isTextElement) {
                propertiesHTML += `
                    <label class="property-label">å­—ä½“é¢œè‰²</label>
                    <input type="color" class="color-picker" value="#000000" onchange="changeTextColor(this.value)">
                    
                    <label class="property-label">èƒŒæ™¯é¢œè‰²</label>
                    <input type="color" class="color-picker" value="#ffffff" onchange="changeBackgroundColor(this.value)">
                    
                    <label class="property-label">å†…è¾¹è·</label>
                    <input type="range" class="property-input" min="0" max="50" value="5" onchange="changePadding(this.value)">
                `;
            }
            
            if (isImageElement) {
                propertiesHTML += `
                    <label class="property-label">å®½åº¦ (%)</label>
                    <input type="range" class="property-input" min="10" max="100" value="100" onchange="changeImageWidth(this.value)">
                `;
            }
            
            // åŠ¨æ€éšè—è®¾ç½® - é€‚ç”¨äºæ‰€æœ‰å…ƒç´ 
            const hideRule = element.getAttribute('data-hide-rule') || 'none';
            const hideUsers = element.getAttribute('data-hide-users') || '';
            
            propertiesHTML += `
                <div style="border-top: 1px solid #eee; margin-top: 15px; padding-top: 15px;">
                    <label class="property-label">ğŸ­ åŠ¨æ€éšè—æ¨¡å—</label>
                    <select class="property-input" id="hideRuleSelect" onchange="changeHideRule(this.value)">
                        <option value="none" ${hideRule === 'none' ? 'selected' : ''}>ä¸å¯ç”¨éšè—</option>
                        <option value="show-only" ${hideRule === 'show-only' ? 'selected' : ''}>åªç»™è°çœ‹</option>
                        <option value="hide-for" ${hideRule === 'hide-for' ? 'selected' : ''}>ä¸ç»™è°çœ‹</option>
                    </select>
                    
                    <div id="hideUsersContainer" style="margin-top: 10px; ${hideRule === 'none' ? 'display: none;' : ''}">
                        <label class="property-label">äººç¾¤æ ‡è¯† (ç”¨é€—å·åˆ†éš”)</label>
                        <input type="text" class="property-input" id="hideUsersInput" 
                               value="${hideUsers}" 
                               placeholder="ä¾‹å¦‚: student,tourist,teacher"
                               onchange="changeHideUsers(this.value)">
                    </div>
                </div>
            `;
            
            propertiesHTML += '</div>';
            propertiesContent.innerHTML = propertiesHTML;
        }

        // åˆ é™¤å…ƒç´ 
        function deleteElement(btn) {
            const element = btn.closest('.editable-element');
            if (element && confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå…ƒç´ å—ï¼Ÿ')) {
                // å…ˆä¿å­˜å½“å‰çŠ¶æ€åˆ°æ’¤é”€æ ˆ
                saveStateToUndoStack();
                
                element.remove();
                selectedElement = null;
                document.getElementById('propertiesContent').innerHTML = '<div class="empty-state"><p>é€‰æ‹©å…ƒç´ ä»¥ç¼–è¾‘å±æ€§</p></div>';
                
                // æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºç©ºçŠ¶æ€
                const canvas = document.getElementById('canvas');
                if (canvas.children.length === 0) {
                    canvas.innerHTML = '<div class="empty-state" id="emptyState"><h3>å¼€å§‹åˆ›ä½œæ‚¨çš„æ–‡ç« </h3><p>ç‚¹å‡»å·¥å…·æ æŒ‰é’®æ·»åŠ æ–‡æœ¬ã€å›¾ç‰‡æˆ–å…¶ä»–å…ƒç´ </p></div>';
                }
                
                console.log('å…ƒç´ å·²åˆ é™¤');
            }
        }

        // ç§»åŠ¨å…ƒç´ 
        function moveUp(btn) {
            const element = btn.closest('.editable-element');
            const prev = element.previousElementSibling;
            if (prev && !prev.classList.contains('empty-state')) {
                element.parentNode.insertBefore(element, prev);
            }
        }

        function moveDown(btn) {
            const element = btn.closest('.editable-element');
            const next = element.nextElementSibling;
            if (next) {
                element.parentNode.insertBefore(next, element);
            }
        }

        // æ ¼å¼åŒ–å·¥å…·
        function toggleBold() {
            document.execCommand('bold');
            updateToolbarState();
        }

        function toggleItalic() {
            document.execCommand('italic');
            updateToolbarState();
        }

        function toggleUnderline() {
            document.execCommand('underline');
            updateToolbarState();
        }

        function setAlignment(align) {
            if (selectedElement) {
                // æ£€æŸ¥å…ƒç´ æ˜¯å¦åŒ…å«å›¾ç‰‡
                const img = selectedElement.querySelector('.image-element');
                if (img) {
                    // å¯¹å›¾ç‰‡å…ƒç´ è¿›è¡Œå¯¹é½
                    selectedElement.style.textAlign = align;
                    selectedElement.style.display = 'block';
                    selectedElement.style.width = '100%';
                    
                    // ä¸ºå›¾ç‰‡æ·»åŠ é¢å¤–çš„å¯¹é½æ ·å¼ç¡®ä¿ç”Ÿæ•ˆ
                    if (align === 'center') {
                        img.style.margin = '0 auto';
                        img.style.display = 'block';
                    } else if (align === 'right') {
                        img.style.margin = '0 0 0 auto';
                        img.style.display = 'block';
                    } else { // left
                        img.style.margin = '0 auto 0 0';
                        img.style.display = 'block';
                    }
                } else {
                    // å¯¹æ–‡æœ¬å…ƒç´ è¿›è¡Œå¯¹é½
                    selectedElement.style.textAlign = align;
                }
                console.log(`è®¾ç½®å¯¹é½æ–¹å¼: ${align}ï¼Œå…ƒç´ ç±»å‹: ${img ? 'å›¾ç‰‡' : 'æ–‡æœ¬'}`);
            } else {
                console.log('æœªé€‰ä¸­ä»»ä½•å…ƒç´ ');
            }
        }

        function changeFontFamily() {
            const fontFamily = document.getElementById('fontFamily').value;
            if (selectedElement) {
                selectedElement.style.fontFamily = fontFamily;
            }
        }

        function changeFontSize() {
            const fontSize = document.getElementById('fontSize').value;
            if (selectedElement) {
                selectedElement.style.fontSize = fontSize;
            }
        }

        // å±æ€§ä¿®æ”¹å‡½æ•°
        function changeTextColor(color) {
            if (selectedElement) {
                selectedElement.style.color = color;
            }
        }

        function changeBackgroundColor(color) {
            if (selectedElement) {
                selectedElement.style.backgroundColor = color;
            }
        }

        function changePadding(value) {
            if (selectedElement) {
                selectedElement.style.padding = value + 'px';
            }
        }

        function changeImageWidth(value) {
            if (selectedElement) {
                const img = selectedElement.querySelector('.image-element');
                if (img) {
                    img.style.width = value + '%';
                }
            }
        }

        // ğŸ­ åŠ¨æ€éšè—æ¨¡å—åŠŸèƒ½

        // åˆ‡æ¢åŠ¨æ€éšè—åŠŸèƒ½
        function toggleDynamicHide() {
            if (!selectedElement) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå…ƒç´ ï¼ˆæ–‡æœ¬æ¡†æˆ–å›¾ç‰‡ï¼‰');
                return;
            }
            
            // å¦‚æœå½“å‰å…ƒç´ æ²¡æœ‰éšè—è§„åˆ™ï¼Œè®¾ç½®ä¸º"åªç»™è°çœ‹"
            const currentRule = selectedElement.getAttribute('data-hide-rule') || 'none';
            if (currentRule === 'none') {
                selectedElement.setAttribute('data-hide-rule', 'show-only');
                selectedElement.setAttribute('data-hide-users', '');
                showSuccess('å·²å¯ç”¨åŠ¨æ€éšè—åŠŸèƒ½ï¼Œè¯·åœ¨å³ä¾§è®¾ç½®å…·ä½“è§„åˆ™');
            } else {
                selectedElement.removeAttribute('data-hide-rule');
                selectedElement.removeAttribute('data-hide-users');
                showSuccess('å·²å…³é—­åŠ¨æ€éšè—åŠŸèƒ½');
            }
            
            // æ›´æ–°å±æ€§é¢æ¿
            showElementProperties(selectedElement);
            
            // æ›´æ–°å…ƒç´ æ ·å¼æŒ‡ç¤º
            updateElementHideIndicator(selectedElement);
        }

        // ä¿®æ”¹éšè—è§„åˆ™
        function changeHideRule(rule) {
            if (!selectedElement) return;
            
            if (rule === 'none') {
                selectedElement.removeAttribute('data-hide-rule');
                selectedElement.removeAttribute('data-hide-users');
                document.getElementById('hideUsersContainer').style.display = 'none';
            } else {
                selectedElement.setAttribute('data-hide-rule', rule);
                document.getElementById('hideUsersContainer').style.display = 'block';
            }
            
            updateElementHideIndicator(selectedElement);
            console.log(`è®¾ç½®éšè—è§„åˆ™: ${rule}`);
        }

        // ä¿®æ”¹éšè—ç”¨æˆ·åˆ—è¡¨
        function changeHideUsers(users) {
            if (!selectedElement) return;
            
            // æ¸…ç†ç”¨æˆ·è¾“å…¥ï¼Œç§»é™¤å¤šä½™ç©ºæ ¼
            const cleanUsers = users.split(',').map(u => u.trim()).filter(u => u).join(',');
            selectedElement.setAttribute('data-hide-users', cleanUsers);
            
            updateElementHideIndicator(selectedElement);
            console.log(`è®¾ç½®éšè—ç”¨æˆ·: ${cleanUsers}`);
        }

        // æ›´æ–°å…ƒç´ çš„éšè—æŒ‡ç¤ºå™¨
        function updateElementHideIndicator(element) {
            // ç§»é™¤ç°æœ‰çš„æŒ‡ç¤ºå™¨
            const existingIndicator = element.querySelector('.hide-indicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }
            
            const hideRule = element.getAttribute('data-hide-rule');
            const hideUsers = element.getAttribute('data-hide-users');
            
            if (hideRule && hideRule !== 'none' && hideUsers) {
                const indicator = document.createElement('div');
                indicator.className = 'hide-indicator';
                indicator.style.cssText = `
                    position: absolute;
                    top: -12px;
                    left: -5px;
                    background: #e74c3c;
                    color: white;
                    font-size: 10px;
                    padding: 2px 6px;
                    border-radius: 3px;
                    z-index: 100;
                    pointer-events: none;
                `;
                
                const ruleText = hideRule === 'show-only' ? 'ä»…æ˜¾ç¤º' : 'éšè—';
                indicator.textContent = `ğŸ­ ${ruleText}: ${hideUsers}`;
                
                element.style.position = 'relative';
                element.appendChild(indicator);
            }
        }

        // åº”ç”¨åŠ¨æ€éšè—è§„åˆ™ï¼ˆè®¿å®¢æŸ¥çœ‹æ—¶ä½¿ç”¨ï¼‰
        function applyDynamicHideRules(userType) {
            console.log('åº”ç”¨åŠ¨æ€éšè—è§„åˆ™ï¼Œç”¨æˆ·ç±»å‹:', userType);
            
            const elements = document.querySelectorAll('[data-hide-rule]');
            elements.forEach(element => {
                const hideRule = element.getAttribute('data-hide-rule');
                const hideUsers = element.getAttribute('data-hide-users');
                
                if (!hideRule || !hideUsers) return;
                
                const userList = hideUsers.split(',').map(u => u.trim());
                let shouldHide = false;
                
                if (hideRule === 'show-only') {
                    // åªç»™æŒ‡å®šç”¨æˆ·çœ‹ï¼šå¦‚æœå½“å‰ç”¨æˆ·ä¸åœ¨åˆ—è¡¨ä¸­ï¼Œåˆ™éšè—
                    shouldHide = !userList.includes(userType);
                } else if (hideRule === 'hide-for') {
                    // ä¸ç»™æŒ‡å®šç”¨æˆ·çœ‹ï¼šå¦‚æœå½“å‰ç”¨æˆ·åœ¨åˆ—è¡¨ä¸­ï¼Œåˆ™éšè—
                    shouldHide = userList.includes(userType);
                }
                
                if (shouldHide) {
                    element.style.display = 'none';
                    console.log(`éšè—å…ƒç´ ï¼Œè§„åˆ™: ${hideRule}, ç”¨æˆ·: ${userType}`);
                } else {
                    element.style.display = '';
                    console.log(`æ˜¾ç¤ºå…ƒç´ ï¼Œè§„åˆ™: ${hideRule}, ç”¨æˆ·: ${userType}`);
                }
            });
        }

        // æ›´æ–°å·¥å…·æ çŠ¶æ€
        function updateToolbarState() {
            document.getElementById('boldBtn').classList.toggle('active', document.queryCommandState('bold'));
            document.getElementById('italicBtn').classList.toggle('active', document.queryCommandState('italic'));
            document.getElementById('underlineBtn').classList.toggle('active', document.queryCommandState('underline'));
        }

        // æ¨¡æ€æ¡†ç®¡ç†
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // ğŸ”§ ä¿®å¤4: åŠ è½½èƒŒæ™¯ç´ æ - ä¿®å¤è·¯å¾„é—®é¢˜
        function loadBackgroundAssets() {
            const backgroundAssets = document.getElementById('backgroundAssets');
            // è·å–ç³»ç»Ÿä¸­çš„èƒŒæ™¯å›¾ç‰‡
            fetch('/api/get_shared_assets', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ type: 'backgrounds' })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.assets.length > 0) {
                    backgroundAssets.innerHTML = data.assets.map(asset => {
                        if (asset.type === 'file' && /\.(jpg|jpeg|png|gif|webp|svg)$/i.test(asset.name)) {
                            return `
                                <div class="asset-item" onclick="insertImageElement('/workplace/share/backgrounds/${asset.name}')" title="${asset.name}">
                                    <img src="/workplace/share/backgrounds/${asset.name}" alt="${asset.name}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">
                                </div>
                            `;
                        }
                        return '';
                    }).join('');
                } else {
                    backgroundAssets.innerHTML = '<p style="color: #7f8c8d; text-align: center;">æš‚æ— èƒŒæ™¯å›¾ç‰‡</p>';
                }
            })
            .catch(error => {
                console.error('åŠ è½½èƒŒæ™¯å›¾ç‰‡å¤±è´¥:', error);
                backgroundAssets.innerHTML = '<p style="color: #e74c3c; text-align: center;">åŠ è½½å¤±è´¥</p>';
            });
        }

        // ğŸ”§ ä¿®å¤5: æ”¹å–„ç´ æåº“é¢„è§ˆ - æ˜¾ç¤ºé¢„è§ˆå›¾è€Œä¸æ˜¯æ–‡ä»¶å
        function generateAssetGrid(assets, assetType) {
            let html = '<div class="assets-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; padding: 10px;">';
            
            assets.forEach(asset => {
                if (asset.type === 'file') {
                    const isImage = /\.(jpg|jpeg|png|gif|webp|svg)$/i.test(asset.name);
                    
                    if (isImage && (assetType === 'backgrounds' || assetType === 'icons' || assetType === 'mypictures')) {
                        // ğŸ”§ ä¿®å¤4: ä½¿ç”¨APIè¿”å›çš„å®Œæ•´è·¯å¾„ï¼Œè€Œä¸æ˜¯æ‹¼æ¥è·¯å¾„
                        const assetPath = asset.path || `/workplace/share/${assetType}/${asset.name}`;
                        
                        html += `
                            <div class="asset-item" onclick="insertImageElement('${assetPath}')" title="${asset.name}" style="
                                cursor: pointer; 
                                border: 2px solid #e1e5e9; 
                                border-radius: 10px; 
                                padding: 8px; 
                                transition: all 0.3s ease;
                                background: white;
                                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                                overflow: hidden;
                                width: 120px;
                                height: 120px;
                            " onmouseover="this.style.borderColor='#3498db'; this.style.transform='scale(1.05)'" onmouseout="this.style.borderColor='#e1e5e9'; this.style.transform='scale(1)'">
                                <div style="
                                    width: 100%; 
                                    height: 100%; 
                                    display: flex; 
                                    align-items: center; 
                                    justify-content: center;
                                    overflow: hidden;
                                    border-radius: 6px;
                                    background: #f8f9fa;
                                ">
                                    <img src="${assetPath}" alt="${asset.name}" style="
                                        max-width: 100%; 
                                        max-height: 100%; 
                                        object-fit: contain; 
                                        display: block;
                                    " onerror="this.style.display='none'; this.nextSibling.style.display='flex';" onload="console.log('é¢„è§ˆå›¾åŠ è½½æˆåŠŸ:', this.src)">
                                    <div style="
                                        display: none;
                                        align-items: center;
                                        justify-content: center;
                                        width: 100%;
                                        height: 100%;
                                        font-size: 36px;
                                        color: #7f8c8d;
                                    ">ğŸ“„</div>
                                </div>
                            </div>
                        `;
                    } else if (assetType === 'icons') {
                        // ä¸ºéå›¾åƒå›¾æ ‡æ–‡ä»¶æ˜¾ç¤ºç‰¹æ®Šå›¾æ ‡
                        const assetPath = asset.path || `/workplace/share/${assetType}/${asset.name}`;
                        html += `
                            <div class="asset-item" onclick="useAsset('${assetType}', '${asset.name}')" title="${asset.name}" style="
                                cursor: pointer; 
                                border: 2px solid #e1e5e9; 
                                border-radius: 10px; 
                                padding: 15px; 
                                text-align: center; 
                                min-height: 100px; 
                                display: flex; 
                                flex-direction: column; 
                                justify-content: center;
                                transition: all 0.3s ease;
                                background: white;
                            " onmouseover="this.style.borderColor='#3498db'" onmouseout="this.style.borderColor='#e1e5e9'">
                                <div style="font-size: 36px; margin-bottom: 8px;">ğŸ“„</div>
                            </div>
                        `;
                    }
                }
            });
            
            html += '</div>';
            return html;
        }

        // é¢„è§ˆæ–‡ç« 
        function previewArticle() {
            if (!currentArticle) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ç¯‡æ–‡ç« ');
                return;
            }
            
            const content = getCanvasContent();
            const previewWindow = window.open('', '_blank');
            previewWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>æ–‡ç« é¢„è§ˆ</title>
                    <style>
                        body { 
                            font-family: Arial, sans-serif; 
                            background: #f8f9fa; 
                            padding: 20px; 
                            margin: 0;
                        }
                        .article-container {
                            background: white;
                            max-width: 800px;
                            margin: 0 auto;
                            padding: 40px;
                            box-shadow: 0 0 20px rgba(0,0,0,0.1);
                            border-radius: 5px;
                        }
                        .image-element { max-width: 100%; height: auto; }
                        h1, h2, h3 { color: #2c3e50; }
                        blockquote {
                            border-left: 4px solid #3498db;
                            padding-left: 20px;
                            margin: 20px 0;
                            font-style: italic;
                            color: #7f8c8d;
                        }
                    </style>
                </head>
                <body>
                    <div class="article-container">
                        ${content}
                    </div>
                </body>
                </html>
            `);
        }

        // å·¥å…·å‡½æ•°
        function showError(message) {
            alert('é”™è¯¯: ' + message);
        }

        function showSuccess(message) {
            alert(message);
        }

        // é€€å‡ºç™»å½•
        function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿæœªä¿å­˜çš„æ›´æ”¹å°†ä¸¢å¤±ã€‚')) {
                sessionStorage.clear();
                localStorage.clear();
                window.location.href = 'index.html?logout=true';
            }
        }

        // åˆ é™¤æ–‡ç«  - å»é™¤æˆåŠŸæç¤º
        async function deleteArticle(filename) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ç¯‡æ–‡ç« å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                return;
            }

            try {
                const response = await fetch('/api/delete_article', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        username: currentUser,
                        filename: filename
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    loadUserArticles();
                    
                    // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰æ–‡ç« ï¼Œæ¸…ç©ºç”»å¸ƒ
                    if (currentArticle === filename) {
                        currentArticle = null;
                        const canvas = document.getElementById('canvas');
                        canvas.innerHTML = '<div class="empty-state" id="emptyState"><h3>å¼€å§‹åˆ›ä½œæ‚¨çš„æ–‡ç« </h3><p>ç‚¹å‡»å·¥å…·æ æŒ‰é’®æ·»åŠ æ–‡æœ¬ã€å›¾ç‰‡æˆ–å…¶ä»–å…ƒç´ </p></div>';
                    }
                } else {
                    showError('åˆ é™¤æ–‡ç« å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                console.error('åˆ é™¤æ–‡ç« å¤±è´¥:', error);
                showError('ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•åˆ é™¤æ–‡ç« ');
            }
        }

        // é‡å‘½åæ–‡ç« 
        async function renameArticle(filename) {
            const currentName = filename.replace('.html', '');
            const newName = await showCustomPrompt('è¯·è¾“å…¥æ–°çš„æ–‡ç« åç§°:', currentName);
            
            if (!newName || newName === currentName) {
                return;
            }

            try {
                const response = await fetch('/api/rename_article', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        username: currentUser,
                        old_filename: filename,
                        new_name: newName
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    loadUserArticles();
                    
                    // å¦‚æœé‡å‘½åçš„æ˜¯å½“å‰æ–‡ç« ï¼Œæ›´æ–°å½“å‰æ–‡ç« å
                    if (currentArticle === filename) {
                        currentArticle = data.new_filename;
                    }
                } else {
                    showError('é‡å‘½åæ–‡ç« å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                console.error('é‡å‘½åæ–‡ç« å¤±è´¥:', error);
                showError('ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•é‡å‘½åæ–‡ç« ');
            }
        }

        // æ˜¾ç¤ºç´ æåº“
        async function showAssetLibrary(assetType) {
            console.log('æ˜¾ç¤ºç´ æåº“:', assetType);
            
            try {
                const response = await fetch('/api/get_shared_assets', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ type: assetType })
                });
                
                const data = await response.json();
                if (data.success) {
                    const modal = document.getElementById('assetModal');
                    const modalTitle = document.getElementById('modalTitle');
                    const modalContent = document.getElementById('modalContent');
                    
                    modalTitle.textContent = getAssetTypeTitle(assetType);
                    
                    if (data.assets.length === 0) {
                        modalContent.innerHTML = '<div class="empty-state"><p>æš‚æ— ç´ æ</p></div>';
                    } else {
                        // ğŸ”§ ä¿®å¤1: ç›´æ¥ä½¿ç”¨generateAssetGridç”Ÿæˆé¢„è§ˆå›¾ç½‘æ ¼
                        modalContent.innerHTML = generateAssetGrid(data.assets, assetType);
                    }
                    
                    modal.style.display = 'block';
                    console.log('ç´ æåº“å·²æ‰“å¼€ï¼Œå…±', data.assets.length, 'ä¸ªç´ æ');
                } else {
                    console.error('ç´ æåº“åŠ è½½å¤±è´¥:', data.message);
                    showError('åŠ è½½ç´ æåº“å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                console.error('åŠ è½½ç´ æåº“å¤±è´¥:', error);
                showError('ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•åŠ è½½ç´ æåº“');
            }
        }

        // è·å–ç´ æç±»å‹æ ‡é¢˜
        function getAssetTypeTitle(assetType) {
            const titles = {
                'backgrounds': 'èƒŒæ™¯å›¾ç‰‡åº“',
                'icons': 'å›¾æ ‡åº“',
                'fonts': 'å­—ä½“åº“'
            };
            return titles[assetType] || 'ç´ æåº“';
        }

        // ä½¿ç”¨ç´ æ
        function useAsset(assetType, assetName) {
            if (assetType === 'fonts') {
                // åº”ç”¨å­—ä½“åˆ°é€‰ä¸­å…ƒç´ 
                if (selectedElement) {
                    // æ ¹æ®å­—ä½“æ–‡ä»¶åæ¨æµ‹å­—ä½“family
                    const fontFamily = getFontFamilyFromFilename(assetName);
                    selectedElement.style.fontFamily = fontFamily;
                    showSuccess(`å·²åº”ç”¨å­—ä½“: ${fontFamily}`);
                } else {
                    alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ–‡æœ¬å…ƒç´ ');
                }
            } else {
                // å…¶ä»–ç±»å‹çš„ç´ æå¤„ç†
                const assetPath = `/workplace/share/${assetType}/${assetName}`;
                insertImageElement(assetPath);
            }
            
            closeModal('assetModal');
        }

        // ä»æ–‡ä»¶åè·å–å­—ä½“å®¶æ—
        function getFontFamilyFromFilename(filename) {
            // ç®€å•çš„å­—ä½“æ–‡ä»¶åæ˜ å°„
            const fontMap = {
                'liberation-sans': 'Liberation Sans',
                'liberation-serif': 'Liberation Serif',
                'liberation-mono': 'Liberation Mono',
                'noto-sans': 'Noto Sans CJK SC',
                'noto-serif': 'Noto Serif CJK SC'
            };
            
            for (const [key, value] of Object.entries(fontMap)) {
                if (filename.toLowerCase().includes(key)) {
                    return value;
                }
            }
            
            // é»˜è®¤è¿”å›æ–‡ä»¶åï¼ˆå»æ‰æ‰©å±•åï¼‰
            return filename.replace(/\.[^/.]+$/, "");
        }

        // åº”ç”¨æ¨¡æ¿
        function applyTemplate(templateType) {
            if (!confirm('åº”ç”¨æ¨¡æ¿å°†æ›¿æ¢å½“å‰å†…å®¹ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ')) {
                return;
            }

            const templates = {
                'article': getArticleTemplate(),
                'blog': getBlogTemplate(),
                'news': getNewsTemplate()
            };

            const template = templates[templateType];
            if (template) {
                loadContentToCanvas(template);
                showSuccess(`å·²åº”ç”¨${templateType}æ¨¡æ¿`);
            }
        }

        // æ–‡ç« æ¨¡æ¿
        function getArticleTemplate() {
            return `
                <div class="editable-element" contenteditable="true" style="text-align: center; margin-bottom: 30px;">
                    <h1 style="font-size: 32px; color: #2c3e50; margin-bottom: 10px;">æ–‡ç« æ ‡é¢˜</h1>
                    <p style="color: #7f8c8d; font-size: 14px;">ä½œè€…ï¼šæ‚¨çš„å§“å | å‘å¸ƒæ—¶é—´ï¼š${new Date().toLocaleDateString()}</p>
                    <div class="element-controls">
                        <button class="control-btn" onclick="deleteElement(this)" title="åˆ é™¤">Ã—</button>
                        <button class="control-btn" onclick="moveUp(this)" title="ä¸Šç§»">â†‘</button>
                        <button class="control-btn" onclick="moveDown(this)" title="ä¸‹ç§»">â†“</button>
                    </div>
                </div>
                <div class="editable-element" contenteditable="true" style="margin-bottom: 20px;">
                    <h2 style="color: #34495e; border-bottom: 2px solid #3498db; padding-bottom: 5px;">å¼•è¨€</h2>
                    <p style="line-height: 1.6; text-indent: 2em;">åœ¨è¿™é‡Œå†™ä¸‹æ‚¨çš„æ–‡ç« å¼•è¨€ï¼Œç®€è¦ä»‹ç»æ–‡ç« çš„ä¸»è¦å†…å®¹å’Œè§‚ç‚¹ã€‚</p>
                    <div class="element-controls">
                        <button class="control-btn" onclick="deleteElement(this)" title="åˆ é™¤">Ã—</button>
                        <button class="control-btn" onclick="moveUp(this)" title="ä¸Šç§»">â†‘</button>
                        <button class="control-btn" onclick="moveDown(this)" title="ä¸‹ç§»">â†“</button>
                    </div>
                </div>
                <div class="editable-element" contenteditable="true" style="margin-bottom: 20px;">
                    <h2 style="color: #34495e; border-bottom: 2px solid #3498db; padding-bottom: 5px;">æ­£æ–‡å†…å®¹</h2>
                    <p style="line-height: 1.6; text-indent: 2em;">è¿™é‡Œæ˜¯æ–‡ç« çš„ä¸»è¦å†…å®¹éƒ¨åˆ†ã€‚æ‚¨å¯ä»¥è¯¦ç»†é˜è¿°æ‚¨çš„è§‚ç‚¹ï¼Œæä¾›è®ºæ®å’Œä¾‹è¯ã€‚</p>
                    <p style="line-height: 1.6; text-indent: 2em;">å¯ä»¥æ·»åŠ å¤šä¸ªæ®µè½æ¥ç»„ç»‡æ‚¨çš„å†…å®¹ç»“æ„ã€‚</p>
                    <div class="element-controls">
                        <button class="control-btn" onclick="deleteElement(this)" title="åˆ é™¤">Ã—</button>
                        <button class="control-btn" onclick="moveUp(this)" title="ä¸Šç§»">â†‘</button>
                        <button class="control-btn" onclick="moveDown(this)" title="ä¸‹ç§»">â†“</button>
                    </div>
                </div>
                <div class="editable-element" contenteditable="true">
                    <h2 style="color: #34495e; border-bottom: 2px solid #3498db; padding-bottom: 5px;">ç»“è®º</h2>
                    <p style="line-height: 1.6; text-indent: 2em;">åœ¨è¿™é‡Œæ€»ç»“æ‚¨çš„æ–‡ç« è¦ç‚¹ï¼Œç»™è¯»è€…ç•™ä¸‹æ·±åˆ»å°è±¡ã€‚</p>
                    <div class="element-controls">
                        <button class="control-btn" onclick="deleteElement(this)" title="åˆ é™¤">Ã—</button>
                        <button class="control-btn" onclick="moveUp(this)" title="ä¸Šç§»">â†‘</button>
                        <button class="control-btn" onclick="moveDown(this)" title="ä¸‹ç§»">â†“</button>
                    </div>
                </div>
            `;
        }

        // åšå®¢æ¨¡æ¿
        function getBlogTemplate() {
            return `
                <div class="editable-element" contenteditable="true" style="text-align: center; margin-bottom: 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px; border-radius: 10px;">
                    <h1 style="font-size: 36px; margin-bottom: 10px;">åšå®¢æ ‡é¢˜</h1>
                    <p style="font-size: 16px; opacity: 0.9;">ä¸ªäººåšå®¢ | ${new Date().toLocaleDateString()}</p>
                    <div class="element-controls">
                        <button class="control-btn" onclick="deleteElement(this)" title="åˆ é™¤">Ã—</button>
                        <button class="control-btn" onclick="moveUp(this)" title="ä¸Šç§»">â†‘</button>
                        <button class="control-btn" onclick="moveDown(this)" title="ä¸‹ç§»">â†“</button>
                    </div>
                </div>
                <div class="editable-element" contenteditable="true" style="margin-bottom: 20px;">
                    <p style="font-size: 18px; line-height: 1.8; color: #555; text-indent: 2em;">æ¬¢è¿æ¥åˆ°æˆ‘çš„åšå®¢ï¼åœ¨è¿™é‡Œåˆ†äº«æˆ‘çš„æƒ³æ³•ã€ç»éªŒå’Œç”Ÿæ´»æ„Ÿæ‚Ÿã€‚</p>
                    <div class="element-controls">
                        <button class="control-btn" onclick="deleteElement(this)" title="åˆ é™¤">Ã—</button>
                        <button class="control-btn" onclick="moveUp(this)" title="ä¸Šç§»">â†‘</button>
                        <button class="control-btn" onclick="moveDown(this)" title="ä¸‹ç§»">â†“</button>
                    </div>
                </div>
                <div class="editable-element" contenteditable="true" style="margin-bottom: 20px; background: #f8f9fa; padding: 20px; border-left: 4px solid #3498db;">
                    <h3 style="color: #2c3e50; margin-bottom: 10px;">ğŸ’¡ ä»Šæ—¥æ„Ÿæƒ³</h3>
                    <p style="line-height: 1.6; margin: 0;">åœ¨è¿™é‡Œè®°å½•æ‚¨ä»Šå¤©çš„æƒ³æ³•å’Œæ„Ÿæ‚Ÿ...</p>
                    <div class="element-controls">
                        <button class="control-btn" onclick="deleteElement(this)" title="åˆ é™¤">Ã—</button>
                        <button class="control-btn" onclick="moveUp(this)" title="ä¸Šç§»">â†‘</button>
                        <button class="control-btn" onclick="moveDown(this)" title="ä¸‹ç§»">â†“</button>
                    </div>
                </div>
                <div class="editable-element" contenteditable="true">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">ğŸ“ æ­£æ–‡å†…å®¹</h3>
                    <p style="line-height: 1.6; text-indent: 2em;">å¼€å§‹å†™ä¸‹æ‚¨æƒ³è¦åˆ†äº«çš„å†…å®¹...</p>
                    <div class="element-controls">
                        <button class="control-btn" onclick="deleteElement(this)" title="åˆ é™¤">Ã—</button>
                        <button class="control-btn" onclick="moveUp(this)" title="ä¸Šç§»">â†‘</button>
                        <button class="control-btn" onclick="moveDown(this)" title="ä¸‹ç§»">â†“</button>
                    </div>
                </div>
            `;
        }

        // æ–°é—»æ¨¡æ¿
        function getNewsTemplate() {
            return `
                <div class="editable-element" contenteditable="true" style="margin-bottom: 30px;">
                    <div style="border-bottom: 3px solid #e74c3c; padding-bottom: 15px; margin-bottom: 20px;">
                        <h1 style="font-size: 28px; color: #2c3e50; margin-bottom: 10px; line-height: 1.2;">æ–°é—»æ ‡é¢˜ï¼šé‡è¦äº‹ä»¶æŠ¥é“</h1>
                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 14px; color: #7f8c8d;">
                            <span>ğŸ“ åœ°ç‚¹ï¼šåŒ—äº¬</span>
                            <span>ğŸ•’ æ—¶é—´ï¼š${new Date().toLocaleString()}</span>
                            <span>ğŸ‘¤ è®°è€…ï¼šæ‚¨çš„å§“å</span>
                        </div>
                    </div>
                    <div class="element-controls">
                        <button class="control-btn" onclick="deleteElement(this)" title="åˆ é™¤">Ã—</button>
                        <button class="control-btn" onclick="moveUp(this)" title="ä¸Šç§»">â†‘</button>
                        <button class="control-btn" onclick="moveDown(this)" title="ä¸‹ç§»">â†“</button>
                    </div>
                </div>
                <div class="editable-element" contenteditable="true" style="margin-bottom: 20px; background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px;">
                    <h3 style="color: #856404; margin-bottom: 10px;">ğŸ“¢ æ–°é—»æ‘˜è¦</h3>
                    <p style="margin: 0; font-weight: bold; line-height: 1.4;">åœ¨è¿™é‡Œå†™ä¸‹æ–°é—»çš„æ ¸å¿ƒè¦ç‚¹ï¼Œç®€æ´æ˜äº†åœ°æ¦‚æ‹¬ä¸»è¦ä¿¡æ¯ã€‚</p>
                    <div class="element-controls">
                        <button class="control-btn" onclick="deleteElement(this)" title="åˆ é™¤">Ã—</button>
                        <button class="control-btn" onclick="moveUp(this)" title="ä¸Šç§»">â†‘</button>
                        <button class="control-btn" onclick="moveDown(this)" title="ä¸‹ç§»">â†“</button>
                    </div>
                </div>
                <div class="editable-element" contenteditable="true" style="margin-bottom: 20px;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">ğŸ“° è¯¦ç»†æŠ¥é“</h3>
                    <p style="line-height: 1.6; text-indent: 2em;">è¯¦ç»†æè¿°äº‹ä»¶çš„ç»è¿‡ã€èƒŒæ™¯å’Œç›¸å…³ä¿¡æ¯ã€‚éµå¾ªæ–°é—»å†™ä½œçš„5W1HåŸåˆ™ï¼šè°(Who)ã€ä»€ä¹ˆ(What)ã€ä½•æ—¶(When)ã€ä½•åœ°(Where)ã€ä¸ºä»€ä¹ˆ(Why)ã€å¦‚ä½•(How)ã€‚</p>
                    <p style="line-height: 1.6; text-indent: 2em;">ç»§ç»­æ·»åŠ æ›´å¤šæ®µè½æ¥å®Œå–„æŠ¥é“å†…å®¹ã€‚</p>
                    <div class="element-controls">
                        <button class="control-btn" onclick="deleteElement(this)" title="åˆ é™¤">Ã—</button>
                        <button class="control-btn" onclick="moveUp(this)" title="ä¸Šç§»">â†‘</button>
                        <button class="control-btn" onclick="moveDown(this)" title="ä¸‹ç§»">â†“</button>
                    </div>
                </div>
                <div class="editable-element" contenteditable="true" style="background: #e8f5e8; border-left: 4px solid #27ae60; padding: 15px;">
                    <h3 style="color: #27ae60; margin-bottom: 10px;">ğŸ’¬ ä¸“å®¶è§‚ç‚¹</h3>
                    <p style="line-height: 1.6; margin: 0; font-style: italic;">"åœ¨è¿™é‡Œå¼•ç”¨ä¸“å®¶çš„è§‚ç‚¹å’Œè¯„è®º..."</p>
                    <div style="text-align: right; margin-top: 10px; font-size: 14px; color: #7f8c8d;">â€” ä¸“å®¶å§“åï¼ŒèŒåŠ¡</div>
                    <div class="element-controls">
                        <button class="control-btn" onclick="deleteElement(this)" title="åˆ é™¤">Ã—</button>
                        <button class="control-btn" onclick="moveUp(this)" title="ä¸Šç§»">â†‘</button>
                        <button class="control-btn" onclick="moveDown(this)" title="ä¸‹ç§»">â†“</button>
                    </div>
                </div>
            `;
        }

        // å¯¼å‡ºæ–‡ç«  - æ·»åŠ å¤–è¾¹æ¡†æ ·å¼
        function exportArticle() {
            if (!currentArticle) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ç¯‡æ–‡ç« ');
                return;
            }
            
            const content = getCanvasContent();
            const exportHTML = `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${currentArticle.replace('.html', '')}</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f8f9fa;
            padding: 20px;
            margin: 0;
            line-height: 1.6;
            color: #333;
        }
        .article-container {
            background: white;
            max-width: 800px;
            margin: 0 auto;
            padding: 40px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            border-radius: 5px;
            min-height: 600px;
        }
        .image-element {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 10px 0;
        }
        h1, h2, h3 {
            color: #2c3e50;
        }
        blockquote {
            border-left: 4px solid #3498db;
            padding-left: 20px;
            margin: 20px 0;
            font-style: italic;
            color: #7f8c8d;
        }
    </style>
</head>
<body>
    <div class="article-container">
        ${content}
    </div>
</body>
</html>`;
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const blob = new Blob([exportHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = currentArticle;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showSuccess('æ–‡ç« å¯¼å‡ºæˆåŠŸ');
        }

        // ğŸ”§ ä¿®å¤3: æ’¤é”€å’Œé‡åšåŠŸèƒ½ - å®Œå…¨é‡æ–°å®ç°
        function undo() {
            console.log('æ’¤é”€æ“ä½œï¼Œå½“å‰æ’¤é”€æ ˆå¤§å°:', undoStack.length, 'é‡åšæ ˆå¤§å°:', redoStack.length);
            
            if (undoStack.length > 1) {
                // ä¿å­˜å½“å‰çŠ¶æ€åˆ°é‡åšæ ˆ
                const currentState = getCanvasContent();
                redoStack.push(currentState);
                
                // ç§»é™¤æœ€åä¸€ä¸ªçŠ¶æ€ï¼ˆå½“å‰çŠ¶æ€ï¼‰
                undoStack.pop();
                
                // è·å–ä¸Šä¸€ä¸ªçŠ¶æ€
                const previousState = undoStack[undoStack.length - 1];
                
                // æ¢å¤ä¸Šä¸€ä¸ªçŠ¶æ€
                loadContentToCanvas(previousState);
                
                console.log('æ’¤é”€å®Œæˆï¼Œæ’¤é”€æ ˆå¤§å°:', undoStack.length, 'é‡åšæ ˆå¤§å°:', redoStack.length);
                // ğŸ”§ ä¿®å¤2: ç§»é™¤æˆåŠŸæç¤º
                // showSuccess('æ’¤é”€æ“ä½œå®Œæˆ');
            } else {
                console.log('æ²¡æœ‰å¯æ’¤é”€çš„æ“ä½œ');
                alert('æ²¡æœ‰å¯æ’¤é”€çš„æ“ä½œ');
            }
        }

        function redo() {
            console.log('é‡åšæ“ä½œï¼Œå½“å‰é‡åšæ ˆå¤§å°:', redoStack.length, 'æ’¤é”€æ ˆå¤§å°:', undoStack.length);
            
            if (redoStack.length > 0) {
                // ä¿å­˜å½“å‰çŠ¶æ€åˆ°æ’¤é”€æ ˆ
                const currentState = getCanvasContent();
                undoStack.push(currentState);
                
                // è·å–ä¸‹ä¸€ä¸ªçŠ¶æ€
                const nextState = redoStack.pop();
                
                // æ¢å¤ä¸‹ä¸€ä¸ªçŠ¶æ€
                loadContentToCanvas(nextState);
                
                console.log('é‡åšå®Œæˆï¼Œæ’¤é”€æ ˆå¤§å°:', undoStack.length, 'é‡åšæ ˆå¤§å°:', redoStack.length);
                // ğŸ”§ ä¿®å¤2: ç§»é™¤æˆåŠŸæç¤º
                // showSuccess('é‡åšæ“ä½œå®Œæˆ');
            } else {
                console.log('æ²¡æœ‰å¯é‡åšçš„æ“ä½œ');
                alert('æ²¡æœ‰å¯é‡åšçš„æ“ä½œ');
            }
        }

        // ä¿å­˜çŠ¶æ€åˆ°æ’¤é”€æ ˆ
        function saveStateToUndoStack() {
            const currentState = getCanvasContent();
            
            // é¿å…ä¿å­˜ç›¸åŒçš„çŠ¶æ€
            if (undoStack.length === 0 || undoStack[undoStack.length - 1] !== currentState) {
                undoStack.push(currentState);
                
                // é™åˆ¶æ’¤é”€æ ˆå¤§å°ï¼Œé˜²æ­¢å†…å­˜æº¢å‡º
                if (undoStack.length > 50) {
                    undoStack.shift();
                }
                
                // æ–°çš„æ“ä½œä¼šæ¸…ç©ºé‡åšæ ˆ
                redoStack = [];
                
                console.log('çŠ¶æ€å·²ä¿å­˜åˆ°æ’¤é”€æ ˆï¼Œæ ˆå¤§å°:', undoStack.length);
            }
        }

        // ç›‘å¬ç”»å¸ƒå†…å®¹å˜åŒ– - æ”¹è¿›å®ç°
        function setupUndoRedoListeners() {
            const canvas = document.getElementById('canvas');
            if (!canvas) return;
            
            let timeout;
            let lastSavedContent = getCanvasContent();
            
            // ç›‘å¬æ‰€æœ‰å†…å®¹å˜åŒ–
            const handleContentChange = function() {
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    const currentContent = getCanvasContent();
                    if (currentContent !== lastSavedContent) {
                        saveStateToUndoStack();
                        lastSavedContent = currentContent;
                    }
                }, 1500); // 1.5ç§’åä¿å­˜çŠ¶æ€
            };
            
            // ç»‘å®šå¤šç§äº‹ä»¶
            canvas.addEventListener('input', handleContentChange);
            canvas.addEventListener('DOMSubtreeModified', handleContentChange);
            
            // ä½¿ç”¨MutationObserverç›‘å¬DOMå˜åŒ–
            if (window.MutationObserver) {
                const observer = new MutationObserver(handleContentChange);
                observer.observe(canvas, {
                    childList: true,
                    subtree: true,
                    attributes: true,
                    characterData: true
                });
            }
        }

        debugLog('HTMLæ–‡ç« ç¼–è¾‘å™¨åˆå§‹åŒ–å®Œæˆ');
        
        // ğŸ“ æˆ‘çš„å›¾ç‰‡åŠŸèƒ½
        
        // æ˜¾ç¤ºæˆ‘çš„å›¾ç‰‡
        function showMyPictures() {
            console.log('æ˜¾ç¤ºæˆ‘çš„å›¾ç‰‡');
            
            const modal = document.getElementById('myPicturesModal');
            const content = document.getElementById('myPicturesContent');
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            modal.style.display = 'block';
            
            // åŠ è½½ç”¨æˆ·å›¾ç‰‡
            loadMyPictures();
        }

        // ğŸ“Š è®¿å®¢ç»Ÿè®¡åŠŸèƒ½
        
        // åŠ è½½è®¿å®¢ç»Ÿè®¡
        async function loadVisitorStats() {
            try {
                const response = await fetch('/api/get_visitor_stats', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username: currentUser })
                });
                
                const data = await response.json();
                if (data.success) {
                    displayVisitorStats(data.stats);
                } else {
                    console.error('åŠ è½½è®¿å®¢ç»Ÿè®¡å¤±è´¥:', data.message);
                    displayVisitorStatsError('åŠ è½½å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                console.error('è®¿å®¢ç»Ÿè®¡ç½‘ç»œé”™è¯¯:', error);
                displayVisitorStatsError('ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•åŠ è½½è®¿å®¢ç»Ÿè®¡');
            }
        }

        // æ˜¾ç¤ºè®¿å®¢ç»Ÿè®¡
        function displayVisitorStats(stats) {
            const content = document.getElementById('visitorStatsContent');
            
            if (!stats || stats.length === 0) {
                content.innerHTML = '<div class="no-visitors">ğŸ“Š æš‚æ— è®¿å®¢æ•°æ®<br><small>å½“å…¶ä»–ç”¨æˆ·é€šè¿‡åˆ«åè®¿é—®æ‚¨çš„æ–‡ç« æ—¶ï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯</small></div>';
                return;
            }

            let html = '<ul class="visitor-stats-list">';
            
            // è®¡ç®—æ€»è®¿é—®é‡
            const totalViews = stats.reduce((sum, stat) => sum + stat.viewtime, 0);
            
            // æ·»åŠ æ€»è§ˆ
            html += `
                <li class="visitor-stat-item" style="border-left-color: #e74c3c; background: #fff5f5;">
                    <span class="visitor-identity">ğŸ“Š æ€»è®¿é—®é‡</span>
                    <span class="visitor-count" style="background: #e74c3c;">${totalViews}</span>
                </li>
            `;
            
            // æ˜¾ç¤ºå„ç±»è®¿å®¢ç»Ÿè®¡
            stats.forEach((stat, index) => {
                const percentage = ((stat.viewtime / totalViews) * 100).toFixed(1);
                const colors = ['#3498db', '#27ae60', '#f39c12', '#9b59b6', '#e67e22'];
                const color = colors[index % colors.length];
                
                html += `
                    <li class="visitor-stat-item" style="border-left-color: ${color};">
                        <span class="visitor-identity">${getVisitorTypeIcon(stat.identity)} ${stat.identity}</span>
                        <span class="visitor-count" style="background: ${color};" title="å æ¯” ${percentage}%">${stat.viewtime}</span>
                    </li>
                `;
            });
            
            html += '</ul>';
            
            // æ·»åŠ ä½¿ç”¨è¯´æ˜
            html += `
                <div style="margin-top: 15px; padding: 10px; background: #e8f4f8; border-radius: 4px; font-size: 12px; color: #2c3e50;">
                    <strong>ğŸ’¡ ä½¿ç”¨è¯´æ˜ï¼š</strong><br>
                    â€¢ è®¿å®¢é€šè¿‡ <code>http://localhost:5000/åˆ«å&user=ç±»å‹</code> è®¿é—®æ‚¨çš„æ–‡ç« <br>
                    â€¢ ä¾‹å¦‚ï¼š<code>http://localhost:5000/WHU_PAGE&user=student</code><br>
                    â€¢ ç³»ç»Ÿä¼šè‡ªåŠ¨è®°å½•ä¸åŒç±»å‹è®¿å®¢çš„è®¿é—®æ¬¡æ•°
                </div>
            `;
            
            content.innerHTML = html;
            console.log('âœ… è®¿å®¢ç»Ÿè®¡æ˜¾ç¤ºå®Œæˆï¼Œå…±', stats.length, 'ç§è®¿å®¢ç±»å‹');
        }

        // æ˜¾ç¤ºè®¿å®¢ç»Ÿè®¡é”™è¯¯
        function displayVisitorStatsError(message) {
            const content = document.getElementById('visitorStatsContent');
            content.innerHTML = `<div class="no-visitors">âŒ ${message}</div>`;
        }

        // è·å–è®¿å®¢ç±»å‹å›¾æ ‡
        function getVisitorTypeIcon(identity) {
            const iconMap = {
                'student': 'ğŸ“',
                'teacher': 'ğŸ‘¨â€ğŸ«',
                'tourist': 'ğŸ§³',
                'admin': 'ğŸ‘‘',
                'visitor': 'ğŸ‘¤',
                'guest': 'ğŸŒŸ',
                'member': 'ğŸ”‘',
                'vip': 'ğŸ’'
            };
            
            return iconMap[identity.toLowerCase()] || 'ğŸ‘¤';
        }

        // åˆ·æ–°è®¿å®¢ç»Ÿè®¡
        function refreshVisitorStats() {
            console.log('ğŸ”„ åˆ·æ–°è®¿å®¢ç»Ÿè®¡');
            const content = document.getElementById('visitorStatsContent');
            content.innerHTML = '<div class="loading">åˆ·æ–°ç»Ÿè®¡ä¸­...</div>';
            
            setTimeout(() => {
                loadVisitorStats();
            }, 500); // çŸ­æš‚å»¶è¿Ÿä»¥æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        }

        // åŠ è½½ç”¨æˆ·å›¾ç‰‡åˆ—è¡¨ - ä¿®å¤è·¯å¾„é—®é¢˜
        async function loadMyPictures() {
            try {
                const response = await fetch('/api/get_my_pictures', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username: currentUser })
                });
                
                const data = await response.json();
                if (data.success) {
                    displayMyPictures(data.pictures);
                } else {
                    document.getElementById('myPicturesContent').innerHTML = 
                        '<div class="empty-state"><p>åŠ è½½å¤±è´¥: ' + data.message + '</p></div>';
                }
            } catch (error) {
                console.error('åŠ è½½æˆ‘çš„å›¾ç‰‡å¤±è´¥:', error);
                document.getElementById('myPicturesContent').innerHTML = 
                    '<div class="empty-state"><p>ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•åŠ è½½å›¾ç‰‡</p></div>';
            }
        }

        // æ˜¾ç¤ºç”¨æˆ·å›¾ç‰‡åˆ—è¡¨ - ä¿®å¤å›¾ç‰‡è·¯å¾„å’Œæ˜¾ç¤ºé—®é¢˜
        function displayMyPictures(pictures) {
            const content = document.getElementById('myPicturesContent');
            
            if (pictures.length === 0) {
                content.innerHTML = '<div class="empty-state"><p>è¿˜æ²¡æœ‰å¯¼å…¥å›¾ç‰‡<br><small>ç‚¹å‡»"å¯¼å…¥å›¾ç‰‡"æŒ‰é’®æ·»åŠ æ‚¨çš„å›¾ç‰‡</small></p></div>';
                return;
            }

            let html = '<div class="assets-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; padding: 10px;">';
            
            pictures.forEach(picture => {
                // ğŸ”§ ä¿®å¤å›¾ç‰‡è·¯å¾„ - ä½¿ç”¨æ­£ç¡®çš„APIç«¯ç‚¹
                const picturePath = `/api/get_user_picture/${currentUser}/${picture.name}`;
                console.log('ğŸ–¼ï¸ åŠ è½½ç”¨æˆ·å›¾ç‰‡:', picturePath);
                
                html += `
                    <div class="asset-item" onclick="insertImageElement('${picturePath}'); closeModal('myPicturesModal');" 
                         title="${picture.name}" style="
                        cursor: pointer; 
                        border: 2px solid #e1e5e9; 
                        border-radius: 10px; 
                        padding: 8px; 
                        transition: all 0.3s ease;
                        background: white;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                        overflow: hidden;
                        width: 120px;
                        height: 120px;
                        position: relative;
                    " onmouseover="this.style.borderColor='#3498db'; this.style.transform='scale(1.05)'" 
                       onmouseout="this.style.borderColor='#e1e5e9'; this.style.transform='scale(1)'">
                        <div style="
                            width: 100%; 
                            height: 100%; 
                            display: flex; 
                            align-items: center; 
                            justify-content: center;
                            overflow: hidden;
                            border-radius: 6px;
                            background: #f8f9fa;
                        ">
                            <img src="${picturePath}" alt="${picture.name}" style="
                                max-width: 100%; 
                                max-height: 100%; 
                                object-fit: contain; 
                                display: block;
                            " onerror="console.error('å›¾ç‰‡åŠ è½½å¤±è´¥:', this.src); this.style.display='none'; this.nextSibling.style.display='flex';" 
                               onload="console.log('æˆ‘çš„å›¾ç‰‡åŠ è½½æˆåŠŸ:', this.src)">
                            <div style="
                                display: none;
                                align-items: center;
                                justify-content: center;
                                width: 100%;
                                height: 100%;
                                font-size: 36px;
                                color: #7f8c8d;
                            ">ğŸ“·</div>
                        </div>
                        <button onclick="event.stopPropagation(); deleteMyPicture('${picture.name}')" 
                                style="position: absolute; top: 2px; right: 2px; width: 20px; height: 20px; 
                                       background: rgba(231, 76, 60, 0.8); color: white; border: none; 
                                       border-radius: 50%; font-size: 12px; cursor: pointer; display: none;"
                                class="delete-btn">Ã—</button>
                    </div>
                `;
            });
            
            html += '</div>';
            content.innerHTML = html;
            
            // æ·»åŠ æ‚¬åœæ—¶æ˜¾ç¤ºåˆ é™¤æŒ‰é’®çš„æ•ˆæœ
            setTimeout(() => {
                document.querySelectorAll('.asset-item').forEach(item => {
                    const deleteBtn = item.querySelector('.delete-btn');
                    if (deleteBtn) {
                        item.addEventListener('mouseenter', () => {
                            deleteBtn.style.display = 'block';
                        });
                        item.addEventListener('mouseleave', () => {
                            deleteBtn.style.display = 'none';
                        });
                    }
                });
            }, 100);
        }

        // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
        async function handleMyImageUpload() {
            const files = document.getElementById('uploadImageFile').files;
            if (!files || files.length === 0) return;
            
            const formData = new FormData();
            formData.append('username', currentUser);
            
            // æ·»åŠ æ‰€æœ‰é€‰ä¸­çš„æ–‡ä»¶
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                // éªŒè¯æ–‡ä»¶ç±»å‹
                if (!file.type.match(/^image\/(png|jpeg|jpg)$/)) {
                    alert(`æ–‡ä»¶ "${file.name}" ä¸æ˜¯æ”¯æŒçš„æ ¼å¼ï¼Œè¯·é€‰æ‹© PNG æˆ– JPG æ ¼å¼çš„å›¾ç‰‡ã€‚`);
                    continue;
                }
                
                // éªŒè¯æ–‡ä»¶å¤§å°ï¼ˆ5MBé™åˆ¶ï¼‰
                if (file.size > 5 * 1024 * 1024) {
                    alert(`æ–‡ä»¶ "${file.name}" å¤ªå¤§ï¼Œè¯·é€‰æ‹©å°äº 5MB çš„å›¾ç‰‡ã€‚`);
                    continue;
                }
                
                formData.append('pictures', file);
            }
            
            try {
                // æ˜¾ç¤ºä¸Šä¼ ä¸­çŠ¶æ€
                document.getElementById('myPicturesContent').innerHTML = '<div class="loading">æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...</div>';
                
                const response = await fetch('/api/upload_my_pictures', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                if (data.success) {
                    console.log(`âœ… æˆåŠŸä¸Šä¼  ${data.uploaded_count} å¼ å›¾ç‰‡`);
                    // é‡æ–°åŠ è½½å›¾ç‰‡åˆ—è¡¨
                    loadMyPictures();
                    
                    // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
                    document.getElementById('uploadImageFile').value = '';
                    
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    if (data.uploaded_count > 0) {
                        showSuccess(`æˆåŠŸä¸Šä¼  ${data.uploaded_count} å¼ å›¾ç‰‡`);
                    }
                    if (data.skipped_count > 0) {
                        alert(`è·³è¿‡ ${data.skipped_count} å¼ é‡å¤çš„å›¾ç‰‡`);
                    }
                } else {
                    showError('ä¸Šä¼ å¤±è´¥: ' + data.message);
                    loadMyPictures(); // é‡æ–°åŠ è½½ä»¥æ¢å¤ç•Œé¢
                }
            } catch (error) {
                console.error('ä¸Šä¼ å›¾ç‰‡å¤±è´¥:', error);
                showError('ç½‘ç»œé”™è¯¯ï¼Œä¸Šä¼ å¤±è´¥');
                loadMyPictures(); // é‡æ–°åŠ è½½ä»¥æ¢å¤ç•Œé¢
            }
        }

        // åˆ é™¤æˆ‘çš„å›¾ç‰‡
        async function deleteMyPicture(filename) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤å›¾ç‰‡ "${filename}" å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/delete_my_picture', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        username: currentUser,
                        filename: filename
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    console.log(`ğŸ—‘ï¸ æˆåŠŸåˆ é™¤å›¾ç‰‡: ${filename}`);
                    // é‡æ–°åŠ è½½å›¾ç‰‡åˆ—è¡¨
                    loadMyPictures();
                } else {
                    showError('åˆ é™¤å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                console.error('åˆ é™¤å›¾ç‰‡å¤±è´¥:', error);
                showError('ç½‘ç»œé”™è¯¯ï¼Œåˆ é™¤å¤±è´¥');
            }
        }

        // ğŸ”— æ–‡ç« é“¾æ¥åŠŸèƒ½
        
        // æ’å…¥é“¾æ¥
        function insertLink() {
            const modal = document.getElementById('linkModal');
            modal.style.display = 'block';
            
            // åŠ è½½ç”¨æˆ·çš„æ–‡ç« åˆ—è¡¨
            loadArticleListForLink();
            
            // æ£€æŸ¥æ˜¯å¦é€‰ä¸­äº†å›¾ç‰‡å…ƒç´ 
            if (selectedElement && selectedElement.querySelector('.image-element')) {
                document.getElementById('linkType').value = 'image';
                document.getElementById('linkText').value = 'å›¾ç‰‡é“¾æ¥';
            } else {
                document.getElementById('linkType').value = 'text';
                document.getElementById('linkText').value = 'ç‚¹å‡»è¿™é‡Œ';
            }
        }
        
        // åŠ è½½æ–‡ç« åˆ—è¡¨ç”¨äºé“¾æ¥é€‰æ‹©
        async function loadArticleListForLink() {
            try {
                const response = await fetch('/api/user_articles', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username: currentUser })
                });
                
                const data = await response.json();
                if (data.success) {
                    displayArticleListForLink(data.articles);
                } else {
                    document.getElementById('linkTargetList').innerHTML = 
                        '<div class="empty-state"><p>åŠ è½½å¤±è´¥: ' + data.message + '</p></div>';
                }
            } catch (error) {
                console.error('åŠ è½½æ–‡ç« åˆ—è¡¨å¤±è´¥:', error);
                document.getElementById('linkTargetList').innerHTML = 
                    '<div class="empty-state"><p>ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•åŠ è½½æ–‡ç« åˆ—è¡¨</p></div>';
            }
        }
        
        // æ˜¾ç¤ºç”¨äºé“¾æ¥é€‰æ‹©çš„æ–‡ç« åˆ—è¡¨
        function displayArticleListForLink(articles) {
            const listContainer = document.getElementById('linkTargetList');
            
            if (articles.length === 0) {
                listContainer.innerHTML = '<div class="empty-state"><p>è¿˜æ²¡æœ‰å…¶ä»–æ–‡ç« å¯ä»¥é“¾æ¥</p></div>';
                return;
            }
            
            // æ’é™¤å½“å‰æ­£åœ¨ç¼–è¾‘çš„æ–‡ç« 
            const availableArticles = articles.filter(article => article.filename !== currentArticle);
            
            if (availableArticles.length === 0) {
                listContainer.innerHTML = '<div class="empty-state"><p>æ²¡æœ‰å…¶ä»–æ–‡ç« å¯ä»¥é“¾æ¥</p></div>';
                return;
            }
            
            let html = '<div style="max-height: 200px; overflow-y: auto;">';
            availableArticles.forEach(article => {
                html += `
                    <div class="article-item" onclick="selectLinkTarget('${article.filename}', '${article.name}')" 
                         style="cursor: pointer; margin: 5px 0; padding: 10px; border: 2px solid transparent; border-radius: 4px;"
                         onmouseover="this.style.borderColor='#3498db'" 
                         onmouseout="this.style.borderColor='transparent'">
                        <div class="article-name" style="font-weight: bold; color: #2c3e50;">${article.name}</div>
                        <div style="font-size: 12px; color: #7f8c8d;">æ–‡ä»¶: ${article.filename}</div>
                    </div>
                `;
            });
            html += '</div>';
            
            listContainer.innerHTML = html;
        }
        
        // é€‰æ‹©é“¾æ¥ç›®æ ‡
        function selectLinkTarget(filename, name) {
            // æ¸…é™¤ä¹‹å‰çš„é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('#linkTargetList .article-item').forEach(item => {
                item.style.backgroundColor = '';
                item.style.borderColor = 'transparent';
            });
            
            // é«˜äº®é€‰ä¸­çš„æ–‡ç« 
            event.target.closest('.article-item').style.backgroundColor = '#e8f4f8';
            event.target.closest('.article-item').style.borderColor = '#3498db';
            
            // ä¿å­˜é€‰ä¸­çš„ç›®æ ‡
            window.selectedLinkTarget = {
                filename: filename,
                name: name
            };
            
            console.log('é€‰ä¸­é“¾æ¥ç›®æ ‡:', filename, name);
        }
        
        // æ’å…¥é“¾æ¥å…ƒç´ 
        function insertLinkElement() {
            if (!window.selectedLinkTarget) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç›®æ ‡æ–‡ç« ');
                return;
            }
            
            const linkText = document.getElementById('linkText').value.trim();
            const linkType = document.getElementById('linkType').value;
            
            if (!linkText) {
                alert('è¯·è¾“å…¥é“¾æ¥æ–‡æœ¬');
                return;
            }
            
            // å…ˆä¿å­˜å½“å‰çŠ¶æ€åˆ°æ’¤é”€æ ˆ
            saveStateToUndoStack();
            
            const canvas = document.getElementById('canvas');
            const emptyState = document.getElementById('emptyState');
            
            if (emptyState) emptyState.style.display = 'none';
            
            if (linkType === 'image' && selectedElement && selectedElement.querySelector('.image-element')) {
                // ä¸ºé€‰ä¸­çš„å›¾ç‰‡æ·»åŠ é“¾æ¥
                const img = selectedElement.querySelector('.image-element');
                const linkUrl = `/link/${currentUser}/${window.selectedLinkTarget.filename}?from=${currentArticle}`;
                
                // åˆ›å»ºé“¾æ¥åŒ…è£…
                const linkWrapper = document.createElement('a');
                linkWrapper.href = linkUrl;
                linkWrapper.target = '_blank';
                linkWrapper.style.display = 'block';
                linkWrapper.style.textDecoration = 'none';
                linkWrapper.title = `ç‚¹å‡»æŸ¥çœ‹ï¼š${window.selectedLinkTarget.name}`;
                
                // æ·»åŠ é“¾æ¥æ ·å¼
                img.style.cursor = 'pointer';
                img.style.transition = 'transform 0.3s ease, box-shadow 0.3s ease';
                img.addEventListener('mouseover', function() {
                    this.style.transform = 'scale(1.02)';
                    this.style.boxShadow = '0 8px 16px rgba(52, 152, 219, 0.3)';
                });
                img.addEventListener('mouseout', function() {
                    this.style.transform = 'scale(1)';
                    this.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
                });
                
                // åŒ…è£…å›¾ç‰‡
                img.parentNode.insertBefore(linkWrapper, img);
                linkWrapper.appendChild(img);
                
                // æ·»åŠ é“¾æ¥æŒ‡ç¤ºå™¨
                const linkIndicator = document.createElement('div');
                linkIndicator.innerHTML = `ğŸ”— é“¾æ¥åˆ°ï¼š${window.selectedLinkTarget.name}`;
                linkIndicator.style.cssText = `
                    background: #e8f4f8;
                    color: #2c3e50;
                    padding: 5px 10px;
                    font-size: 12px;
                    text-align: center;
                    border-radius: 4px;
                    margin-top: 5px;
                    border: 1px solid #3498db;
                `;
                selectedElement.appendChild(linkIndicator);
                
            } else {
                // æ’å…¥æ–‡æœ¬é“¾æ¥
                const linkContainer = document.createElement('div');
                linkContainer.className = 'editable-element';
                
                const linkUrl = `/link/${currentUser}/${window.selectedLinkTarget.filename}?from=${currentArticle}`;
                
                linkContainer.innerHTML = `
                    <a href="${linkUrl}" target="_blank" style="
                        color: #3498db;
                        text-decoration: none;
                        font-weight: bold;
                        padding: 8px 16px;
                        border: 2px solid #3498db;
                        border-radius: 6px;
                        display: inline-block;
                        transition: all 0.3s ease;
                        background: linear-gradient(45deg, transparent 0%, rgba(52, 152, 219, 0.1) 100%);
                    " onmouseover="
                        this.style.backgroundColor='#3498db';
                        this.style.color='white';
                        this.style.transform='translateY(-2px)';
                        this.style.boxShadow='0 4px 8px rgba(52, 152, 219, 0.3)';
                    " onmouseout="
                        this.style.backgroundColor='transparent';
                        this.style.color='#3498db';
                        this.style.transform='translateY(0)';
                        this.style.boxShadow='none';
                    " title="ç‚¹å‡»æŸ¥çœ‹ï¼š${window.selectedLinkTarget.name}">
                        ğŸ”— ${linkText}
                    </a>
                    <div style="font-size: 12px; color: #7f8c8d; margin-top: 5px;">
                        é“¾æ¥åˆ°ï¼š${window.selectedLinkTarget.name}
                    </div>
                    <div class="element-controls">
                        <button class="control-btn" onclick="deleteElement(this)" title="åˆ é™¤">Ã—</button>
                        <button class="control-btn" onclick="moveUp(this)" title="ä¸Šç§»">â†‘</button>
                        <button class="control-btn" onclick="moveDown(this)" title="ä¸‹ç§»">â†“</button>
                    </div>
                `;
                
                canvas.appendChild(linkContainer);
                linkContainer.addEventListener('click', selectElement);
                selectElement({ target: linkContainer });
            }
            
            console.log(`âœ… å·²æ’å…¥${linkType === 'image' ? 'å›¾ç‰‡' : 'æ–‡æœ¬'}é“¾æ¥åˆ°ï¼š${window.selectedLinkTarget.name}`);
            
            // å…³é—­æ¨¡æ€æ¡†å¹¶æ¸…ç†
            closeModal('linkModal');
            window.selectedLinkTarget = null;
        }

        // ğŸ”‘ ä¿®æ”¹å¯†ç åŠŸèƒ½

        // æ˜¾ç¤ºä¿®æ”¹å¯†ç æ¨¡æ€æ¡†
        function showChangePasswordModal() {
            console.log('æ˜¾ç¤ºä¿®æ”¹å¯†ç æ¨¡æ€æ¡†');
            const modal = document.getElementById('changePasswordModal');
            modal.style.display = 'block';
            
            // æ¸…ç©ºè¡¨å•
            document.getElementById('currentPassword').value = '';
            document.getElementById('changePasswordVerificationCode').value = '';
            document.getElementById('changePasswordErrorMessage').style.display = 'none';
            document.getElementById('changePasswordSuccessMessage').style.display = 'none';
            document.getElementById('changePasswordCountdown').textContent = '';
            
            const sendCodeBtn = document.getElementById('sendChangePasswordCodeBtn');
            sendCodeBtn.disabled = false;
            sendCodeBtn.textContent = 'å‘é€éªŒè¯ç ';
        }

        // å‘é€ä¿®æ”¹å¯†ç éªŒè¯ç 
        async function sendChangePasswordCode() {
            const currentPassword = document.getElementById('currentPassword').value.trim();
            
            if (!currentPassword) {
                showChangePasswordError('è¯·è¾“å…¥å½“å‰å¯†ç ');
                return;
            }
            
            try {
                // éªŒè¯å½“å‰å¯†ç 
                const encryptedCurrentPassword = window.CryptoUtils.convertToEncryptedHex(currentPassword);
                const verifyResponse = await fetch('/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: currentUser,
                        password: encryptedCurrentPassword
                    })
                });
                
                const verifyResult = await verifyResponse.json();
                if (!verifyResult.success) {
                    showChangePasswordError('å½“å‰å¯†ç é”™è¯¯');
                    return;
                }
                
                // æ˜¾ç¤ºäººæœºéªŒè¯
                showChangePasswordCaptcha();
                
            } catch (error) {
                console.error('éªŒè¯å½“å‰å¯†ç å¤±è´¥:', error);
                showChangePasswordError('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }

        // æ˜¾ç¤ºä¿®æ”¹å¯†ç çš„äººæœºéªŒè¯
        function showChangePasswordCaptcha() {
            const modal = document.getElementById('changePasswordCaptchaModal');
            modal.style.display = 'block';
            
            const checkbox = document.getElementById('changePasswordRobotCheck');
            checkbox.checked = false;
            
            const confirmBtn = document.getElementById('changePasswordCaptchaConfirm');
            confirmBtn.disabled = true;
        }

        // å¤„ç†ä¿®æ”¹å¯†ç çš„äººæœºéªŒè¯
        function handleChangePasswordCaptcha() {
            const checkbox = document.getElementById('changePasswordRobotCheck');
            const confirmBtn = document.getElementById('changePasswordCaptchaConfirm');
            confirmBtn.disabled = !checkbox.checked;
        }

        // ç¡®è®¤ä¿®æ”¹å¯†ç çš„äººæœºéªŒè¯
        async function confirmChangePasswordCaptcha() {
            closeModal('changePasswordCaptchaModal');
            
            try {
                // å‘é€éªŒè¯ç åˆ°ç”¨æˆ·é‚®ç®±
                const response = await fetch('/api/send_change_password_code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username: currentUser })
                });
                
                const data = await response.json();
                if (data.success) {
                    showChangePasswordSuccess('éªŒè¯ç å·²å‘é€åˆ°æ‚¨çš„é‚®ç®±ï¼Œè¯·æŸ¥æ”¶');
                    startChangePasswordCountdown();
                } else {
                    showChangePasswordError('å‘é€éªŒè¯ç å¤±è´¥: ' + data.message);
                }
                
            } catch (error) {
                console.error('å‘é€éªŒè¯ç å¤±è´¥:', error);
                showChangePasswordError('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }

        // å¼€å§‹å€’è®¡æ—¶
        function startChangePasswordCountdown() {
            const sendCodeBtn = document.getElementById('sendChangePasswordCodeBtn');
            const countdownDiv = document.getElementById('changePasswordCountdown');
            
            sendCodeBtn.disabled = true;
            let countdown = 60;
            
            const interval = setInterval(() => {
                countdownDiv.textContent = `è¯·ç­‰å¾… ${countdown} ç§’åé‡è¯•`;
                countdown--;
                
                if (countdown < 0) {
                    clearInterval(interval);
                    sendCodeBtn.disabled = false;
                    sendCodeBtn.textContent = 'å‘é€éªŒè¯ç ';
                    countdownDiv.textContent = '';
                }
            }, 1000);
        }

        // è¿›å…¥ä¸‹ä¸€æ­¥ï¼šè®¾ç½®æ–°å¯†ç 
        async function proceedToNewPassword() {
            const verificationCode = document.getElementById('changePasswordVerificationCode').value.trim();
            
            if (!verificationCode) {
                showChangePasswordError('è¯·è¾“å…¥éªŒè¯ç ');
                return;
            }
            
            try {
                // éªŒè¯éªŒè¯ç 
                const response = await fetch('/api/verify_change_password_code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        username: currentUser,
                        code: verificationCode
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    closeModal('changePasswordModal');
                    showNewPasswordModal();
                } else {
                    showChangePasswordError('éªŒè¯ç é”™è¯¯: ' + data.message);
                }
                
            } catch (error) {
                console.error('éªŒè¯ç éªŒè¯å¤±è´¥:', error);
                showChangePasswordError('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }

        // æ˜¾ç¤ºæ–°å¯†ç è®¾ç½®æ¨¡æ€æ¡†
        function showNewPasswordModal() {
            const modal = document.getElementById('newPasswordModal');
            modal.style.display = 'block';
            
            // æ¸…ç©ºè¡¨å•
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmNewPassword').value = '';
            document.getElementById('newPasswordStrength').textContent = '';
            document.getElementById('newPasswordErrorMessage').style.display = 'none';
            document.getElementById('newPasswordSuccessMessage').style.display = 'none';
        }

        // æ£€æŸ¥æ–°å¯†ç å¼ºåº¦
        function checkNewPasswordStrength() {
            const password = document.getElementById('newPassword').value;
            const strengthElement = document.getElementById('newPasswordStrength');
            
            if (!password) {
                strengthElement.textContent = '';
                return;
            }
            
            let score = 0;
            const checks = {
                hasNumber: /\d/.test(password),
                hasLower: /[a-z]/.test(password),
                hasUpper: /[A-Z]/.test(password),
                hasUnderscore: /_/.test(password)
            };
            
            score = Object.values(checks).filter(Boolean).length;
            
            let strengthText = '';
            let strengthClass = '';
            
            switch (score) {
                case 1:
                    strengthText = 'å¯†ç å¼ºåº¦ï¼šå¼±';
                    strengthClass = 'strength-weak';
                    break;
                case 2:
                    strengthText = 'å¯†ç å¼ºåº¦ï¼šä¸­';
                    strengthClass = 'strength-medium';
                    break;
                case 3:
                    strengthText = 'å¯†ç å¼ºåº¦ï¼šå¼º';
                    strengthClass = 'strength-strong';
                    break;
                case 4:
                    strengthText = 'å¯†ç å¼ºåº¦ï¼šæå¼º';
                    strengthClass = 'strength-very-strong';
                    break;
                default:
                    strengthText = 'å¯†ç å¼ºåº¦ï¼šå¼±';
                    strengthClass = 'strength-weak';
            }
            
            strengthElement.textContent = strengthText;
            strengthElement.className = `password-strength ${strengthClass}`;
        }

        // æ›´æ–°ç”¨æˆ·å¯†ç 
        async function updateUserPassword() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmNewPassword').value;
            
            // éªŒè¯å¯†ç 
            if (newPassword.length < 6 || newPassword.length > 16) {
                showNewPasswordError('å¯†ç é•¿åº¦å¿…é¡»åœ¨6-16ä½ä¹‹é—´');
                return;
            }
            
            const validChars = /^[a-zA-Z0-9_]+$/;
            if (!validChars.test(newPassword)) {
                showNewPasswordError('å¯†ç åªèƒ½åŒ…å«æ•°å­—ã€å¤§å°å†™å­—æ¯å’Œä¸‹åˆ’çº¿');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showNewPasswordError('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
                return;
            }
            
            try {
                // åŠ å¯†æ–°å¯†ç 
                const encryptedPassword = window.CryptoUtils.convertToEncryptedHex(newPassword);
                
                // æ›´æ–°å¯†ç 
                const response = await fetch('/api/change_user_password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        username: currentUser,
                        password: encryptedPassword
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    console.log('âœ… å¯†ç ä¿®æ”¹æˆåŠŸï¼Œæ­£åœ¨è·³è½¬åˆ°ç™»å½•é¡µé¢...');
                    // ç›´æ¥æ‰§è¡Œé‡æ–°ç™»å½•ï¼Œä¸æ˜¾ç¤ºç¡®è®¤å¼¹çª—
                    logout();
                } else {
                    showNewPasswordError('å¯†ç ä¿®æ”¹å¤±è´¥: ' + data.message);
                }
                
            } catch (error) {
                console.error('å¯†ç ä¿®æ”¹å¤±è´¥:', error);
                showNewPasswordError('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }

        // æ˜¾ç¤ºä¿®æ”¹å¯†ç é”™è¯¯ä¿¡æ¯
        function showChangePasswordError(message) {
            const errorElement = document.getElementById('changePasswordErrorMessage');
            errorElement.innerHTML = message;
            errorElement.style.display = 'block';
            document.getElementById('changePasswordSuccessMessage').style.display = 'none';
        }

        // æ˜¾ç¤ºä¿®æ”¹å¯†ç æˆåŠŸä¿¡æ¯
        function showChangePasswordSuccess(message) {
            const successElement = document.getElementById('changePasswordSuccessMessage');
            successElement.innerHTML = message;
            successElement.style.display = 'block';
            document.getElementById('changePasswordErrorMessage').style.display = 'none';
        }

        // æ˜¾ç¤ºæ–°å¯†ç é”™è¯¯ä¿¡æ¯
        function showNewPasswordError(message) {
            const errorElement = document.getElementById('newPasswordErrorMessage');
            errorElement.innerHTML = message;
            errorElement.style.display = 'block';
            document.getElementById('newPasswordSuccessMessage').style.display = 'none';
        }

        // ğŸŒ è®¿å®¢é€šé“ç®¡ç†åŠŸèƒ½

        // æ˜¾ç¤ºè®¿å®¢é€šé“ç®¡ç†æ¨¡æ€æ¡†
        function showVisitorAccessModal() {
            console.log('æ˜¾ç¤ºè®¿å®¢é€šé“ç®¡ç†æ¨¡æ€æ¡†');
            const modal = document.getElementById('visitorAccessModal');
            modal.style.display = 'block';
            
            // åŠ è½½æ•°æ®
            loadVisitorLinks();
            loadArticlesForVisitor();
            
            // æ¸…ç©ºè¡¨å•
            document.getElementById('visitorArticleSelect').value = '';
            document.getElementById('visitorAlias').value = '';
            document.getElementById('visitorAccessErrorMessage').style.display = 'none';
            document.getElementById('visitorAccessSuccessMessage').style.display = 'none';
        }

        // åŠ è½½è®¿å®¢é“¾æ¥åˆ—è¡¨
        async function loadVisitorLinks() {
            try {
                const response = await fetch('/api/get_visitor_links', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username: currentUser })
                });
                
                const data = await response.json();
                if (data.success) {
                    displayVisitorLinks(data.links);
                } else {
                    document.getElementById('visitorLinksList').innerHTML = 
                        '<div class="empty-state"><p>åŠ è½½å¤±è´¥: ' + data.message + '</p></div>';
                }
            } catch (error) {
                console.error('åŠ è½½è®¿å®¢é“¾æ¥å¤±è´¥:', error);
                document.getElementById('visitorLinksList').innerHTML = 
                    '<div class="empty-state"><p>ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•åŠ è½½è®¿å®¢é“¾æ¥</p></div>';
            }
        }

        // æ˜¾ç¤ºè®¿å®¢é“¾æ¥åˆ—è¡¨
        function displayVisitorLinks(links) {
            const container = document.getElementById('visitorLinksList');
            
            if (links.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>è¿˜æ²¡æœ‰è®¿å®¢é“¾æ¥</p></div>';
                return;
            }
            
            let html = '<div style="max-height: 200px; overflow-y: auto;">';
            links.forEach(link => {
                html += `
                    <div class="article-item" style="margin: 5px 0; padding: 10px; background: #f8f9fa; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <div style="font-weight: bold; color: #2c3e50; margin-bottom: 2px;">${link.alias}</div>
                            <div style="font-size: 12px; color: #7f8c8d;">${link.article_name}</div>
                        </div>
                        <div style="flex: 0 0 auto; margin-left: 15px;">
                            <button class="btn btn-secondary" onclick="removeVisitorLink('${link.alias}')" 
                                    style="padding: 4px 12px; font-size: 12px; background: #e74c3c; color: white; border: none;" 
                                    onmouseover="this.style.background='#c0392b'" 
                                    onmouseout="this.style.background='#e74c3c'">åˆ é™¤</button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }

        // åŠ è½½æ–‡ç« åˆ—è¡¨ä¾›è®¿å®¢é€šé“é€‰æ‹©
        async function loadArticlesForVisitor() {
            try {
                const response = await fetch('/api/user_articles', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username: currentUser })
                });
                
                const data = await response.json();
                if (data.success) {
                    const select = document.getElementById('visitorArticleSelect');
                    select.innerHTML = '<option value="">è¯·é€‰æ‹©æ–‡ç« </option>';
                    
                    data.articles.forEach(article => {
                        const option = document.createElement('option');
                        option.value = article.filename;
                        option.textContent = article.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('åŠ è½½æ–‡ç« åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        // æ·»åŠ è®¿å®¢é“¾æ¥
        async function addVisitorLink() {
            const articleFile = document.getElementById('visitorArticleSelect').value;
            const alias = document.getElementById('visitorAlias').value.trim();
            
            if (!articleFile) {
                showVisitorAccessError('è¯·é€‰æ‹©æ–‡ç« ');
                return;
            }
            
            if (!alias) {
                showVisitorAccessError('è¯·è¾“å…¥åˆ«å');
                return;
            }
            
            try {
                const response = await fetch('/api/add_visitor_link', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        username: currentUser,
                        article_file: articleFile,
                        alias: alias
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    showVisitorAccessSuccess('è®¿å®¢é“¾æ¥æ·»åŠ æˆåŠŸ');
                    loadVisitorLinks();
                    
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('visitorArticleSelect').value = '';
                    document.getElementById('visitorAlias').value = '';
                } else {
                    showVisitorAccessError('æ·»åŠ å¤±è´¥: ' + data.message);
                }
                
            } catch (error) {
                console.error('æ·»åŠ è®¿å®¢é“¾æ¥å¤±è´¥:', error);
                showVisitorAccessError('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }

        // åˆ é™¤è®¿å®¢é“¾æ¥
        async function removeVisitorLink(alias) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤è®¿å®¢é“¾æ¥ "${alias}" å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/remove_visitor_link', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        username: currentUser,
                        alias: alias
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    showVisitorAccessSuccess('è®¿å®¢é“¾æ¥åˆ é™¤æˆåŠŸ');
                    loadVisitorLinks();
                } else {
                    showVisitorAccessError('åˆ é™¤å¤±è´¥: ' + data.message);
                }
                
            } catch (error) {
                console.error('åˆ é™¤è®¿å®¢é“¾æ¥å¤±è´¥:', error);
                showVisitorAccessError('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }

        // æ˜¾ç¤ºè®¿å®¢é€šé“é”™è¯¯ä¿¡æ¯
        function showVisitorAccessError(message) {
            const errorElement = document.getElementById('visitorAccessErrorMessage');
            errorElement.innerHTML = message;
            errorElement.style.display = 'block';
            document.getElementById('visitorAccessSuccessMessage').style.display = 'none';
        }

        // æ˜¾ç¤ºè®¿å®¢é€šé“æˆåŠŸä¿¡æ¯
        function showVisitorAccessSuccess(message) {
            const successElement = document.getElementById('visitorAccessSuccessMessage');
            successElement.innerHTML = message;
            successElement.style.display = 'block';
            document.getElementById('visitorAccessErrorMessage').style.display = 'none';
        }
    </script>
</body>
</html> 